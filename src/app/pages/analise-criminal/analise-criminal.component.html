<div class="analise-container">

  @if (isLoading) {
    <div class="loading-overlay">
      <div class="loading-content">
        <div class="spinner-golden"></div>
        <h3>Carregando An√°lise Criminal</h3>
        <p>Baixando mapas e estat√≠sticas de Roraima...</p>
        <div class="loading-steps">
          <div class="step" [class.active]="loadingStep >= 1">
            <i class="bi bi-check-circle-fill"></i>
            <span>Conectando √† API</span>
          </div>
          <div class="step" [class.active]="loadingStep >= 2">
            <i class="bi bi-check-circle-fill"></i>
            <span>Carregando estat√≠sticas</span>
          </div>
          <div class="step" [class.active]="loadingStep >= 3">
            <i class="bi bi-check-circle-fill"></i>
            <span>Baixando tiles do mapa</span>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- ==========================================
       HEADER COMPACTO COM LINK PARA DASHBOARD
       ========================================== -->
  <div class="header-analise">
    <div class="header-left">
      <h1><i class="bi bi-map"></i> An√°lise Criminal</h1>
      <p class="subtitle">Visualiza√ß√£o geogr√°fica de ocorr√™ncias</p>
    </div>

    <div class="header-right">
      @if (semResultados && !isLoading && estatisticas) {
        <div class="header-notification warning">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <div class="notification-text">
            @if (estatisticas.total_ocorrencias > 0) {
              <strong>{{ estatisticas.total_ocorrencias }} ocorr√™ncia(s) sem coordenadas</strong>
              <small>N√£o possuem lat/lng para exibi√ß√£o no mapa</small>
            } @else {
              <strong>Nenhuma ocorr√™ncia encontrada</strong>
              <small>Ajuste os filtros</small>
            }
          </div>
        </div>
      }

      <!-- üÜï LINK PARA O DASHBOARD -->
      <a routerLink="/gabinete-virtual/operacional/dashboard-criminal" class="btn-dashboard">
        <i class="bi bi-graph-up-arrow"></i>
        Ver Dashboard Completo
      </a>
    </div>
  </div>

  <!-- ==========================================
       FILTROS COMPACTOS (LINHA √öNICA)
       ========================================== -->
  <div class="filtros-card compact">
    <div class="filtros-inline">
      <div class="filtro-group">
        <label>Per√≠odo</label>
        <div class="filtro-periodo">
          <input type="date" [(ngModel)]="filtros.data_inicio" class="form-control-filtro">
          <span>at√©</span>
          <input type="date" [(ngModel)]="filtros.data_fim" class="form-control-filtro">
        </div>
      </div>

      <div class="filtro-group">
        <label>Classifica√ß√£o</label>
        <select
          [ngModel]="filtros.classificacao_id ?? ''"
          (ngModelChange)="filtros.classificacao_id = $event === '' ? undefined : +$event"
          class="form-control-filtro">
          <option value="">Todas</option>
          @for (c of classificacoes; track c.id) {
            <option [value]="c.id">{{ c.codigo }} - {{ c.nome }}</option>
          }
        </select>
      </div>

      <div class="filtro-group">
        <label>Cidade</label>
        <select
          [ngModel]="filtros.cidade_id ?? ''"
          (ngModelChange)="filtros.cidade_id = $event === '' ? undefined : +$event"
          class="form-control-filtro">
          <option value="">Todas</option>
          @for (cidade of cidades; track cidade.id) {
            <option [value]="cidade.id">{{ cidade.nome }}</option>
          }
        </select>
      </div>

      <div class="filtro-group">
        <label>Bairro</label>
        <input
          type="text"
          [(ngModel)]="filtros.bairro"
          class="form-control-filtro"
          placeholder="Digite...">
      </div>

      <div class="filtros-actions">
        <button class="btn-filtrar" (click)="aplicarFiltros()">
          <i class="bi bi-search"></i>
          Filtrar
        </button>
        <button class="btn-limpar" (click)="limparFiltros()">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>
  </div>

  @if (!isLoading && estatisticas) {
    <!-- ==========================================
         LAYOUT PRINCIPAL: MAPA + SIDEBAR
         ========================================== -->
    <div class="main-layout">

      <!-- MAPA (PRIORIDADE) -->
      <div class="mapa-card">
        <div class="mapa-header">
          <div class="mapa-info">
            <i class="bi bi-map"></i>
            <h3>Mapa de Calor</h3>
            <span class="badge-count">{{ ocorrenciasGeo.length }} ocorr√™ncias</span>
          </div>
          <button class="btn-toggle-view" (click)="alternarVisualizacao()">
            @if (visualizacao === 'heatmap') {
              <i class="bi bi-pin-map"></i>
              Marcadores
            } @else {
              <i class="bi bi-fire"></i>
              Mapa de Calor
            }
          </button>
        </div>

        <div id="map" class="mapa"></div>
      </div>

      <!-- SIDEBAR DE ESTAT√çSTICAS (COMPACTA) -->
      <div class="stats-sidebar">
        <!-- Total -->
        <div class="stat-total">
          <i class="bi bi-file-earmark-text"></i>
          <div class="stat-info">
            <span class="stat-value">{{ estatisticas.total_ocorrencias }}</span>
            <span class="stat-label">Total de Ocorr√™ncias</span>
          </div>
        </div>

        <!-- Top Classifica√ß√µes -->
        <div class="stat-card-mini">
          <div class="stat-header-mini">
            <i class="bi bi-bar-chart"></i>
            <span>Top 5 Classifica√ß√µes</span>
          </div>
          <div class="stat-list-mini">
            @for (item of estatisticas.por_classificacao.slice(0, 5); track item.classificacao) {
              <div class="stat-item-mini">
                <span class="item-label">{{ item.classificacao }}</span>
                <span class="item-badge">{{ item.quantidade }}</span>
              </div>
            }
            @if (estatisticas.por_classificacao.length === 0) {
              <p class="empty-state">Nenhum dado</p>
            }
          </div>
        </div>

        <!-- Top Cidades -->
        <div class="stat-card-mini">
          <div class="stat-header-mini">
            <i class="bi bi-building"></i>
            <span>Top 5 Cidades</span>
          </div>
          <div class="stat-list-mini">
            @for (item of estatisticas.por_cidade.slice(0, 5); track item.cidade) {
              <div class="stat-item-mini">
                <span class="item-label">{{ item.cidade }}</span>
                <span class="item-badge">{{ item.quantidade }}</span>
              </div>
            }
            @if (estatisticas.por_cidade.length === 0) {
              <p class="empty-state">Nenhum dado</p>
            }
          </div>
        </div>

        <!-- Top Bairros -->
        <div class="stat-card-mini">
          <div class="stat-header-mini">
            <i class="bi bi-geo-alt"></i>
            <span>Top 5 Bairros</span>
          </div>
          <div class="stat-list-mini">
            @for (item of estatisticas.por_bairro.slice(0, 5); track item.bairro) {
              <div class="stat-item-mini">
                <span class="item-label">{{ item.bairro }}</span>
                <span class="item-badge">{{ item.quantidade }}</span>
              </div>
            }
            @if (estatisticas.por_bairro.length === 0) {
              <p class="empty-state">Sem dados</p>
            }
          </div>
        </div>

        <!-- Link Dashboard -->
        <a routerLink="/gabinete-virtual/operacional/dashboard-criminal" class="btn-ver-mais">
          <i class="bi bi-graph-up-arrow"></i>
          Ver estat√≠sticas detalhadas
          <i class="bi bi-arrow-right"></i>
        </a>
      </div>
    </div>
  }
</div>
