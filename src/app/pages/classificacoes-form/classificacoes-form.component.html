<div class="container">
  <div class="header-actions">
    <button class="btn-back" (click)="cancelar()">
      <i class="bi bi-arrow-left"></i> Voltar
    </button>
    <h1>{{ isEditMode ? 'Editar Classificação' : 'Nova Classificação' }}</h1>
  </div>

  @if (isLoading || isLoadingGrupos) {
    <div class="loading">
      <i class="bi bi-hourglass-split"></i>
      <p>Carregando dados...</p>
    </div>
  }

  @if (message) {
    <div class="message" [ngClass]="{'success': messageType === 'success', 'error': messageType === 'error'}">
      {{ message }}
    </div>
  }

  @if (!isLoading && !isLoadingGrupos) {
    <div class="form-container">
      <div class="info-box">
        <i class="bi bi-info-circle"></i>
        <div>
          <strong>Estrutura Hierárquica e Associações:</strong>
          <p>
            Deixe "Grupo Pai" vazio para criar um <strong>Grupo Principal</strong>.
            Associe os <strong>Grupos Principais</strong> aos Serviços Periciais para que os subgrupos herdem a associação.
          </p>
        </div>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="parent_id">
            <i class="bi bi-diagram-3"></i>
            Grupo Pai (Opcional)
          </label>
          <select id="parent_id" formControlName="parent_id" class="form-control">
            <option [value]="null">Nenhum (Esta é um Grupo Principal)</option>
            @for (grupo of gruposPrincipais; track grupo.id) {
              <option [value]="grupo.id">{{ grupo.codigo }} - {{ grupo.nome }}</option>
            }
          </select>
          <small class="hint">Selecione um grupo para criar um subgrupo.</small>
        </div>

        <!-- --- INÍCIO DO NOVO CAMPO --- -->
        <div class="form-group">
          <label for="servicos_periciais_ids">
            <i class="bi bi-building"></i>
            Serviços Periciais Associados
          </label>
          <select
            id="servicos_periciais_ids"
            formControlName="servicos_periciais_ids"
            class="form-control"
            multiple
            size="5"
          >
            @for (servico of servicosPericiais; track servico.id) {
              <option [value]="servico.id">{{ servico.sigla }} - {{ servico.nome }}</option>
            }
          </select>
          <small class="hint">Segure CTRL (ou Command no Mac) para selecionar múltiplos serviços. Associe apenas aos Grupos Principais.</small>
        </div>
        <!-- --- FIM DO NOVO CAMPO --- -->

        <div class="form-group">
          <label for="codigo">
            <i class="bi bi-hash"></i>
            Código *
          </label>
          <input
            type="text"
            id="codigo"
            formControlName="codigo"
            class="form-control"
            placeholder="Ex: 1.0.0 ou 1.0.0.1"
            maxlength="20"
            [class.error]="codigo?.invalid && codigo?.touched"
          >
          @if (codigo?.invalid && codigo?.touched) {
            <div class="error-message">
              @if (codigo?.errors?.['required']) { <span>O código é obrigatório.</span> }
              @if (codigo?.errors?.['maxlength']) { <span>O código deve ter no máximo 20 caracteres.</span> }
            </div>
          }
          <small class="hint">Use formato numérico separado por pontos (ex: 1.0.0 para grupo, 1.0.0.1 para subgrupo)</small>
        </div>

        <div class="form-group">
          <label for="nome">
            <i class="bi bi-file-text"></i>
            Nome *
          </label>
          <input
            type="text"
            id="nome"
            formControlName="nome"
            class="form-control"
            placeholder="Ex: ACIDENTE DE TRÂNSITO COM VÍTIMA FATAL"
            maxlength="255"
            [class.error]="nome?.invalid && nome?.touched"
          >
          @if (nome?.invalid && nome?.touched) {
            <div class="error-message">
              @if (nome?.errors?.['required']) { <span>O nome é obrigatório.</span> }
              @if (nome?.errors?.['maxlength']) { <span>O nome deve ter no máximo 255 caracteres.</span> }
            </div>
          }
          <small class="hint">Será convertido automaticamente para maiúsculas</small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="isSaving">
            <i class="bi bi-x-circle"></i>
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="form.invalid || isSaving">
            <i class="bi bi-check-circle"></i>
            {{ isSaving ? 'Salvando...' : (isEditMode ? 'Atualizar' : 'Cadastrar') }}
          </button>
        </div>
      </form>
    </div>
  }
</div>
