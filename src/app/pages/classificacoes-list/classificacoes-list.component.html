<div class="container">
  <div class="header-row">
    <div>
      <h1>Gerenciamento de Classificações de Ocorrências</h1>
      <p class="subtitle">Organize classificações em grupos e subgrupos hierárquicos.</p>
    </div>
    <div class="actions-header">
      <button class="btn-primary" (click)="onCreate()">
        <i class="bi bi-plus-circle"></i>
        Nova Classificação
      </button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab" [class.active]="viewMode === 'ativos'" (click)="switchToAtivos()">
      <i class="bi bi-list-ul"></i>
      Ativos
    </button>
    @if (isSuperAdmin) {
      <button class="tab" [class.active]="viewMode === 'lixeira'" (click)="switchToLixeira()">
        <i class="bi bi-trash"></i>
        Lixeira
      </button>
    }
  </div>

  <div class="search-container">
    <i class="bi bi-search"></i>
    <input type="text" [(ngModel)]="searchTerm" placeholder="Buscar por código ou nome..." class="search-input">
    @if (searchTerm) {
      <button class="clear-search" (click)="searchTerm = ''">
        <i class="bi bi-x-circle"></i>
      </button>
    }
  </div>

  @if (message) {
    <div class="message" [ngClass]="{'success': messageType === 'success', 'error': messageType === 'error'}">
      {{ message }}
    </div>
  }

  @if (viewMode === 'ativos') {
    @if (isLoading) {
      <div class="loading-indicator">
        <i class="bi bi-hourglass-split"></i>
        <p>Carregando classificações...</p>
      </div>
    }

    @if (!isLoading && classificacoesFiltradas.length > 0) {
      <div class="classificacoes-tree">
        @for (grupo of gruposPrincipais; track grupo.id) {
          <div class="grupo-card">
            <div class="grupo-header">
              <div class="grupo-info">
                <span class="grupo-codigo">{{ grupo.codigo }}</span>
                <span class="grupo-nome">{{ grupo.nome }}</span>
                <span class="badge-grupo">Grupo Principal</span>

                <!-- --- INÍCIO DA MODIFICAÇÃO (GRUPO) --- -->
                <div class="servicos-badges">
                  @for (servico of grupo.servicos_periciais; track servico.id) {
                    <span class="badge-servico">{{ servico.sigla }}</span>
                  }
                </div>
                <!-- --- FIM DA MODIFICAÇÃO (GRUPO) --- -->
              </div>
              <div class="grupo-meta">
                <small>Cadastrado em: {{ grupo.created_at | date:'dd/MM/yyyy' }} por: {{ getFirstName(grupo.created_by?.nome_completo) }}</small>
                @if (hasBeenUpdated(grupo)) {
                  <small>Atualizado em: {{ grupo.updated_at | date:'dd/MM/yyyy' }} por: {{ getFirstName(grupo.updated_by?.nome_completo) }}</small>
                }
              </div>
              <div class="grupo-actions">
                <button class="icon-btn edit" title="Editar" (click)="onEdit(grupo.id)">
                  <i class="bi bi-pencil"></i>
                </button>
                @if (isSuperAdmin) {
                  <button class="icon-btn danger" title="Mover para Lixeira" (click)="onDelete(grupo)">
                    <i class="bi bi-trash"></i>
                  </button>
                }
              </div>
            </div>

            @if (getSubgrupos(grupo.id).length > 0) {
              <div class="subgrupos-list">
                @for (subgrupo of getSubgrupos(grupo.id); track subgrupo.id) {
                  <div class="subgrupo-item">
                    <div class="subgrupo-connector"></div>
                    <div class="subgrupo-content">
                      <div class="subgrupo-info">
                        <span class="subgrupo-codigo">{{ subgrupo.codigo }}</span>
                        <span class="subgrupo-nome">{{ subgrupo.nome }}</span>
                        <span class="badge-subgrupo">Subgrupo</span>

                        <!-- --- INÍCIO DA MODIFICAÇÃO (SUBGRUPO) --- -->
                        <!-- Subgrupos herdam e mostram os serviços do pai -->
                        <div class="servicos-badges inherited">
                          @for (servico of grupo.servicos_periciais; track servico.id) {
                            <span class="badge-servico">{{ servico.sigla }}</span>
                          }
                        </div>
                        <!-- --- FIM DA MODIFICAÇÃO (SUBGRUPO) --- -->
                      </div>
                      <div class="subgrupo-meta">
                        <small>Cadastrado em: {{ subgrupo.created_at | date:'dd/MM/yyyy' }} por: {{ getFirstName(subgrupo.created_by?.nome_completo) }}</small>
                        @if (hasBeenUpdated(subgrupo)) {
                          <small>Atualizado em: {{ subgrupo.updated_at | date:'dd/MM/yyyy' }} por: {{ getFirstName(subgrupo.updated_by?.nome_completo) }}</small>
                        }
                      </div>
                      <div class="subgrupo-actions">
                        <button class="icon-btn edit" title="Editar" (click)="onEdit(subgrupo.id)">
                          <i class="bi bi-pencil"></i>
                        </button>
                        @if (isSuperAdmin) {
                          <button class="icon-btn danger" title="Mover para Lixeira" (click)="onDelete(subgrupo)">
                            <i class="bi bi-trash"></i>
                          </button>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    @if (!isLoading && classificacoesFiltradas.length === 0) {
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <p>{{ searchTerm ? 'Nenhuma classificação encontrada' : 'Nenhuma classificação cadastrada' }}</p>
      </div>
    }
  }

  @if (viewMode === 'lixeira') {
    @if (isLoadingLixeira) {
      <div class="loading-indicator">
        <i class="bi bi-hourglass-split"></i>
        <p>Carregando lixeira...</p>
      </div>
    }

    @if (!isLoadingLixeira && classificacoesLixeiraFiltradas.length > 0) {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nome</th>
              <th>Grupo Pai</th>
              <th>Deletado em</th>
              <th>Deletado por</th>
              <th class="actions-header">Ações</th>
            </tr>
          </thead>
          <tbody>
            @for (classificacao of classificacoesLixeiraFiltradas; track classificacao.id) {
              <tr>
                <td data-label="Código" class="codigo-cell deleted">{{ classificacao.codigo }}</td>
                <td data-label="Nome" class="deleted">{{ classificacao.nome }}</td>
                <td data-label="Grupo Pai">{{ classificacao.parent?.nome || 'Grupo Principal' }}</td>
                <td data-label="Deletado em">{{ classificacao.deleted_at | date:'dd/MM/yyyy HH:mm' }}</td>
                <td data-label="Deletado por">{{ classificacao.deleted_by?.nome_completo || 'N/D' }}</td>
                <td class="actions-cell" data-label="Ações">
                  <button class="icon-btn restore" title="Restaurar" (click)="onRestore(classificacao)">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    @if (!isLoadingLixeira && classificacoesLixeiraFiltradas.length === 0) {
      <div class="empty-state">
        <i class="bi bi-trash"></i>
        <p>{{ searchTerm ? 'Nenhuma classificação encontrada' : 'A lixeira está vazia' }}</p>
      </div>
    }
  }
</div>
