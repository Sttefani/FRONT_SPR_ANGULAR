<div class="dashboard-container">
  <!-- Header Unificado: Bem-vindo + Filtro -->
  <div class="header-section">
    <div class="welcome-content">
      <h1>Bem-vindo, {{ getFirstName(currentUser?.nome_completo) }}!</h1>
      <p class="user-role">{{ currentUser?.perfil }}</p>
    </div>

    @if (mostrarFiltroServico()) {
      <div class="filtro-servico">
        <label>Filtrar por ServiÃ§o:</label>
        <select [(ngModel)]="servicoSelecionado" (change)="onServicoChange()">
          <option [value]="null">
            @if (isPerito()) {
              Todos os Meus ServiÃ§os
            } @else {
              Todos os ServiÃ§os
            }
          </option>
          @for (servico of servicosDisponiveis; track servico.id) {
            <option [value]="servico.id">{{ servico.sigla }} - {{ servico.nome }}</option>
          }
        </select>
      </div>
    }
  </div>

  <!-- Loading -->
  @if (isLoading) {
    <div class="loading">
      <i class="bi bi-hourglass-split"></i>
      <p>Carregando estatÃ­sticas...</p>
    </div>
  }

  <!-- Layout: Cards + GrÃ¡fico PERITO -->
  @if (!isLoading && isPerito() && estatisticas) {
    <div class="dashboard-layout">
      <!-- Coluna Esquerda: Cards -->
      <div class="stats-grid">
        <!-- Total -->
        <div class="stat-card primary">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-content">
            <h3>Minhas OcorrÃªncias</h3>
            <p class="stat-number">{{ estatisticas.minhas_ocorrencias.total }}</p>
          </div>
        </div>

        <!-- Em AnÃ¡lise -->
        <div class="stat-card warning">
          <div class="stat-icon">ğŸ”</div>
          <div class="stat-content">
            <h3>Em AnÃ¡lise</h3>
            <p class="stat-number">{{ estatisticas.minhas_ocorrencias.em_analise }}</p>
          </div>
        </div>

        <!-- Finalizadas -->
        <div class="stat-card success">
          <div class="stat-icon">âœ…</div>
          <div class="stat-content">
            <h3>Finalizadas</h3>
            <p class="stat-number">{{ estatisticas.minhas_ocorrencias.finalizadas }}</p>
            <small>{{ estatisticas.minhas_ocorrencias.taxa_finalizacao }}% de conclusÃ£o</small>
          </div>
        </div>

        <!-- Atrasadas -->
        <div class="stat-card danger">
          <div class="stat-icon">âš ï¸</div>
          <div class="stat-content">
            <h3>Atrasadas</h3>
            <p class="stat-number">{{ estatisticas.minhas_ocorrencias.atrasadas }}</p>
            <small>Mais de 20 dias</small>
          </div>
        </div>

        <!-- Finalizadas este mÃªs -->
        <div class="stat-card info">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-content">
            <h3>Finalizadas este MÃªs</h3>
            <p class="stat-number">{{ estatisticas.minhas_ocorrencias.finalizadas_este_mes }}</p>
          </div>
        </div>

        <!-- ParticipaÃ§Ã£o no ServiÃ§o -->
        <div class="stat-card secondary">
          <div class="stat-icon">ğŸ“Š</div>
          <div class="stat-content">
            <h3>Minha ParticipaÃ§Ã£o</h3>
            <p class="stat-number">{{ estatisticas.servico.minha_participacao }}%</p>
            <small>Do total do serviÃ§o ({{ estatisticas.servico.total_geral }} ocorrÃªncias)</small>
          </div>
        </div>
      </div>

      <!-- Coluna Direita: GrÃ¡fico -->
      <div class="grafico-section">
        <div class="grafico-card">
          <h3>ğŸ“Š DistribuiÃ§Ã£o de OcorrÃªncias</h3>
          <canvas id="chartPerito"></canvas>
        </div>
      </div>
    </div>

    <!-- Ãšltimas OcorrÃªncias -->
    @if (estatisticas.ultimas_ocorrencias && estatisticas.ultimas_ocorrencias.length > 0) {
      <div class="recent-section">
        <h2>Ãšltimas OcorrÃªncias</h2>
        <div class="recent-list">
          @for (ocorrencia of estatisticas.ultimas_ocorrencias; track ocorrencia.id) {
            <div class="recent-item">
              <strong>{{ ocorrencia.numero_ocorrencia }}</strong>
              <span class="badge" [ngClass]="'badge-' + ocorrencia.status.toLowerCase()">
                {{ ocorrencia.status }}
              </span>
              <small>{{ ocorrencia.created_at | date:'dd/MM/yyyy' }}</small>
            </div>
          }
        </div>
      </div>
    }
  }

  <!-- Layout: Cards + GrÃ¡fico ADMIN/OPERACIONAL -->
  @if (!isLoading && isAdminOrOperacional() && estatisticas) {
    <div class="dashboard-layout">
      <!-- Coluna Esquerda: Cards -->
      <div class="stats-grid">
        <!-- Total Geral -->
        <div class="stat-card primary">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-content">
            <h3>Total de OcorrÃªncias</h3>
            <p class="stat-number">{{ estatisticas.geral.total }}</p>
          </div>
        </div>

        <!-- Aguardando Perito -->
        <div class="stat-card info">
          <div class="stat-icon">â³</div>
          <div class="stat-content">
            <h3>Aguardando Perito</h3>
            <p class="stat-number">{{ estatisticas.geral.aguardando }}</p>
          </div>
        </div>

        <!-- Em AnÃ¡lise -->
        <div class="stat-card warning">
          <div class="stat-icon">ğŸ”</div>
          <div class="stat-content">
            <h3>Em AnÃ¡lise</h3>
            <p class="stat-number">{{ estatisticas.geral.em_analise }}</p>
          </div>
        </div>

        <!-- Finalizadas -->
        <div class="stat-card success">
          <div class="stat-icon">âœ…</div>
          <div class="stat-content">
            <h3>Finalizadas</h3>
            <p class="stat-number">{{ estatisticas.geral.finalizadas }}</p>
          </div>
        </div>

        <!-- Sem Perito -->
        <div class="stat-card secondary">
          <div class="stat-icon">ğŸ‘¤</div>
          <div class="stat-content">
            <h3>Sem Perito</h3>
            <p class="stat-number">{{ estatisticas.geral.sem_perito }}</p>
          </div>
        </div>

        <!-- Atrasadas -->
        <div class="stat-card danger">
          <div class="stat-icon">âš ï¸</div>
          <div class="stat-content">
            <h3>Atrasadas</h3>
            <p class="stat-number">{{ estatisticas.geral.atrasadas }}</p>
            <small>Mais de 20 dias</small>
          </div>
        </div>

        <!-- Finalizadas este mÃªs -->
        <div class="stat-card info">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-content">
            <h3>Finalizadas este MÃªs</h3>
            <p class="stat-number">{{ estatisticas.geral.finalizadas_este_mes }}</p>
          </div>
        </div>

        <!-- Ãšltimos 30 dias -->
        <div class="stat-card highlight">
          <div class="stat-icon">ğŸ“ˆ</div>
          <div class="stat-content">
            <h3>Ãšltimos 30 Dias</h3>
            <p class="stat-number">{{ estatisticas.ultimos_30_dias.criadas }}</p>
            <small>{{ estatisticas.ultimos_30_dias.finalizadas }} finalizadas</small>
          </div>
        </div>
      </div>

      <!-- Coluna Direita: GrÃ¡fico -->
      <div class="grafico-section">
        <div class="grafico-card">
          <h3>ğŸ“Š DistribuiÃ§Ã£o de OcorrÃªncias</h3>
          <canvas id="chartAdmin"></canvas>
        </div>
      </div>
    </div>

    <!-- Por ServiÃ§o -->
    @if (estatisticas.por_servico && estatisticas.por_servico.length > 0) {
      <div class="recent-section">
        <h2>Top 5 ServiÃ§os</h2>
        <div class="servico-list">
          @for (servico of estatisticas.por_servico; track $index) {
            <div class="servico-item">
              <span class="servico-sigla">{{ servico.servico_pericial__sigla }}</span>
              <span class="servico-nome">{{ servico.servico_pericial__nome }}</span>
              <span class="servico-total">{{ servico.total }} ocorrÃªncias</span>
            </div>
          }
        </div>
      </div>
    }
  }
</div>
