<div class="container">
  <div class="header-actions">
    <button class="btn-back" (click)="cancelar()">
      <i class="bi bi-arrow-left"></i> Voltar
    </button>
    <h1>{{ isEditMode ? 'Editar Exame' : 'Novo Exame' }}</h1>
  </div>

  @if (isLoading || isLoadingServicos || isLoadingExamesPais) {
    <div class="loading">
      <i class="bi bi-hourglass-split"></i>
      <p>Carregando dados...</p>
    </div>
  }

  @if (message) {
    <div class="message" [ngClass]="{'success': messageType === 'success', 'error': messageType === 'error'}">
      {{ message }}
    </div>
  }

  @if (!isLoading && !isLoadingServicos && !isLoadingExamesPais) {
    <div class="form-container">
      <form [formGroup]="exameForm" (ngSubmit)="onSubmit()">

        <div class="form-group">
          <label for="servico_pericial_id">
            <i class="bi bi-folder2-open"></i>
            Serviço Pericial *
          </label>
          <select
            id="servico_pericial_id"
            formControlName="servico_pericial_id"
            (change)="onServicoChange()"
            class="form-control"
            [class.error]="servico_pericial_id?.invalid && servico_pericial_id?.touched"
          >
            <option [value]="null">Selecione um serviço...</option>
            @for (servico of servicosPericiais; track servico.id) {
              <option [value]="servico.id">{{ servico.sigla }} - {{ servico.nome }}</option>
            }
          </select>
          @if (servico_pericial_id?.invalid && servico_pericial_id?.touched) {
            <div class="error-message">
              <span>O serviço pericial é obrigatório.</span>
            </div>
          }
          <small class="hint">Selecione primeiro o serviço pericial responsável</small>
        </div>

        <div class="form-group">
          <label for="parent_id">
            <i class="bi bi-diagram-3"></i>
            Exame Pai (Opcional)
          </label>
          <select
            id="parent_id"
            formControlName="parent_id"
            class="form-control"
            [disabled]="!servico_pericial_id?.value || examesPais.length === 0"
          >
            <option [value]="null">Nenhum (Exame Principal)</option>
            @for (pai of examesPais; track pai.id) {
              <option [value]="pai.id">{{ pai.codigo }} - {{ pai.nome }}</option>
            }
          </select>
          <small class="hint">Deixe vazio para criar um exame principal ou selecione para criar um sub-exame</small>
        </div>

        <div class="form-group">
          <label for="codigo">
            <i class="bi bi-hash"></i>
            Código *
          </label>
          <input
            type="text"
            id="codigo"
            formControlName="codigo"
            class="form-control"
            placeholder="Ex: 1.0.0 ou 1.0.0.1"
            maxlength="20"
            [class.error]="codigo?.invalid && codigo?.touched"
          >
          @if (codigo?.invalid && codigo?.touched) {
            <div class="error-message">
              @if (codigo?.errors?.['required']) {
                <span>O código é obrigatório.</span>
              }
              @if (codigo?.errors?.['maxlength']) {
                <span>O código deve ter no máximo 20 caracteres.</span>
              }
            </div>
          }
          <small class="hint">Use formato numérico separado por pontos</small>
        </div>

        <div class="form-group">
          <label for="nome">
            <i class="bi bi-file-text"></i>
            Nome *
          </label>
          <input
            type="text"
            id="nome"
            formControlName="nome"
            class="form-control"
            placeholder="Ex: EXAME DE DNA"
            maxlength="255"
            [class.error]="nome?.invalid && nome?.touched"
          >
          @if (nome?.invalid && nome?.touched) {
            <div class="error-message">
              @if (nome?.errors?.['required']) {
                <span>O nome é obrigatório.</span>
              }
              @if (nome?.errors?.['maxlength']) {
                <span>O nome deve ter no máximo 255 caracteres.</span>
              }
            </div>
          }
          <small class="hint">Será convertido automaticamente para maiúsculas</small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="isSaving">
            <i class="bi bi-x-circle"></i>
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="exameForm.invalid || isSaving">
            <i class="bi bi-check-circle"></i>
            {{ isSaving ? 'Salvando...' : (isEditMode ? 'Atualizar' : 'Cadastrar') }}
          </button>
        </div>
      </form>
    </div>
  }
</div>
