<div class="container">
  <div class="header-row">
    <div>
      <h1>Gerenciamento de Exames</h1>
      <p class="subtitle">Organize exames por serviço pericial em grupos hierárquicos.</p>
    </div>

    <div class="actions-header">
      <button class="btn-primary" (click)="onCreate()">
        <i class="bi bi-plus-circle"></i>
        Novo Exame
      </button>
    </div>
  </div>

  <div class="filter-row">
    <div class="filter-group">
      <label for="servico-filter">Filtrar por Serviço Pericial:</label>
      <select
        id="servico-filter"
        [(ngModel)]="servicoPericialFiltro"
        (change)="onServicoChange()"
        class="filter-select"
      >
        <option [value]="null">Todos os Serviços</option>
        @for (servico of servicosPericiais; track servico.id) {
          <option [value]="servico.id">{{ servico.nome }}</option>
        }
      </select>
    </div>
  </div>

  <div class="tabs">
    <button
      class="tab"
      [class.active]="viewMode === 'ativos'"
      (click)="switchToAtivos()">
      <i class="bi bi-list-ul"></i>
      Ativos
    </button>
    @if (isSuperAdmin) {
      <button
        class="tab"
        [class.active]="viewMode === 'lixeira'"
        (click)="switchToLixeira()">
        <i class="bi bi-trash"></i>
        Lixeira
      </button>
    }
  </div>

  <div class="search-container">
    <i class="bi bi-search"></i>
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar por código ou nome..."
      class="search-input"
    >
    @if (searchTerm) {
      <button class="clear-search" (click)="searchTerm = ''">
        <i class="bi bi-x-circle"></i>
      </button>
    }
  </div>

  @if (message) {
    <div class="message" [ngClass]="{'success': messageType === 'success', 'error': messageType === 'error'}">
      {{ message }}
    </div>
  }

  @if (viewMode === 'ativos') {
    @if (isLoading) {
      <div class="loading-indicator">
        <i class="bi bi-hourglass-split"></i>
        <p>Carregando exames...</p>
      </div>
    }

    @if (!isLoading && examesFiltrados.length > 0) {
      <div class="exames-tree">
        @for (grupo of gruposPrincipais; track grupo.id) {
          <div class="grupo-card">
            <div class="grupo-header">
              <div class="grupo-info">
                <span class="grupo-codigo">{{ grupo.codigo }}</span>
                <span class="grupo-nome">{{ grupo.nome }}</span>
                <span class="badge-servico">{{ grupo.servico_pericial.nome }}</span>
                <span class="badge-grupo">Grupo Principal</span>
              </div>
              <div class="grupo-meta">
                <small>Cadastrado em: {{ grupo.created_at | date:'dd/MM/yyyy' }}</small>
                <small>Por: {{ getFirstName(grupo.created_by?.nome_completo) }}</small>
              </div>
              <div class="grupo-actions">
                <button class="icon-btn edit" title="Editar" (click)="onEdit(grupo.id)">
                  <i class="bi bi-pencil"></i>
                </button>
                @if (isSuperAdmin) {
                  <button class="icon-btn danger" title="Mover para Lixeira" (click)="onDelete(grupo)">
                    <i class="bi bi-trash"></i>
                  </button>
                }
              </div>
            </div>

            @if (getSubExames(grupo.id).length > 0) {
              <div class="subexames-list">
                @for (subexame of getSubExames(grupo.id); track subexame.id) {
                  <div class="subexame-item">
                    <div class="subexame-connector"></div>
                    <div class="subexame-content">
                      <div class="subexame-info">
                        <span class="subexame-codigo">{{ subexame.codigo }}</span>
                        <span class="subexame-nome">{{ subexame.nome }}</span>
                        <span class="badge-subexame">Sub-exame</span>
                      </div>
                      <div class="subexame-meta">
                        <small>Cadastrado em: {{ subexame.created_at | date:'dd/MM/yyyy' }}</small>
                        <small>Por: {{ getFirstName(subexame.created_by?.nome_completo) }}</small>
                      </div>
                      <div class="subexame-actions">
                        <button class="icon-btn edit" title="Editar" (click)="onEdit(subexame.id)">
                          <i class="bi bi-pencil"></i>
                        </button>
                        @if (isSuperAdmin) {
                          <button class="icon-btn danger" title="Mover para Lixeira" (click)="onDelete(subexame)">
                            <i class="bi bi-trash"></i>
                          </button>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    @if (!isLoading && examesFiltrados.length === 0) {
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <p>{{ searchTerm ? 'Nenhum exame encontrado' : 'Nenhum exame cadastrado' }}</p>
      </div>
    }
  }

  @if (viewMode === 'lixeira') {
    @if (isLoadingLixeira) {
      <div class="loading-indicator">
        <i class="bi bi-hourglass-split"></i>
        <p>Carregando lixeira...</p>
      </div>
    }

    @if (!isLoadingLixeira && examesLixeiraFiltrados.length > 0) {
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nome</th>
              <th>Serviço</th>
              <th>Grupo Pai</th>
              <th>Deletado em</th>
              <th>Deletado por</th>
              <th class="actions-header">Ações</th>
            </tr>
          </thead>
          <tbody>
            @for (exame of examesLixeiraFiltrados; track exame.id) {
              <tr>
                <td data-label="Código" class="codigo-cell deleted">{{ exame.codigo }}</td>
                <td data-label="Nome" class="deleted">{{ exame.nome }}</td>
                <td data-label="Serviço">{{ exame.servico_pericial.nome }}</td>
                <td data-label="Grupo Pai">{{ exame.parent?.nome || 'Grupo Principal' }}</td>
                <td data-label="Deletado em">{{ exame.deleted_at | date:'dd/MM/yyyy HH:mm' }}</td>
                <td data-label="Deletado por">{{ exame.deleted_by?.nome_completo || 'N/D' }}</td>
                <td class="actions-cell" data-label="Ações">
                  <button class="icon-btn restore" title="Restaurar" (click)="onRestore(exame)">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    @if (!isLoadingLixeira && examesLixeiraFiltrados.length === 0) {
      <div class="empty-state">
        <i class="bi bi-trash"></i>
        <p>{{ searchTerm ? 'Nenhum exame encontrado' : 'A lixeira está vazia' }}</p>
      </div>
    }
  }
</div>
