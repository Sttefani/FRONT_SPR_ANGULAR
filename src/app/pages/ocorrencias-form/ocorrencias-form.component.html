<div class="container">
  <!-- ========== HEADER ========== -->
  <div class="header-form">
    <div>
      <h1>{{ isEditMode ? 'Editar Ocorrência' : 'Nova Ocorrência' }}</h1>
      <p class="subtitle">
        {{ isEditMode ? 'Atualize os dados da ocorrência' : 'Siga as etapas para registrar uma nova ocorrência' }}
      </p>
    </div>
    <button class="btn-cancel" (click)="cancelar()">
      <i class="bi bi-x-circle"></i>
      Cancelar
    </button>
  </div>

  <!-- ========== ETAPA 1: TEM PROCEDIMENTO? ========== -->
  @if (etapaAtual === 'procedimento-check' && !isEditMode) {
    <div class="wizard-step">
      <div class="question-card">
        <div class="question-icon">
          <i class="bi bi-question-circle"></i>
        </div>
        <h2>A ocorrência que você vai registrar possui um procedimento vinculado?</h2>
        <p class="question-subtitle">
          Procedimentos como Inquérito Policial (IP), Auto de Prisão em Flagrante (APF), etc.
        </p>

        <div class="button-group-large">
          <button class="btn-choice yes" (click)="onTemProcedimentoSim()">
            <i class="bi bi-check-circle"></i>
            <span>Sim, possui procedimento</span>
          </button>
          <button class="btn-choice no" (click)="onTemProcedimentoNao()">
            <i class="bi bi-x-circle"></i>
            <span>Não possui</span>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ========== ETAPA 2: BUSCAR PROCEDIMENTO ========== -->
  @if (etapaAtual === 'busca-procedimento') {
    <div class="wizard-step">
      <div class="search-card">
        <div class="card-header-info">
          <i class="bi bi-search"></i>
          <div>
            <h2>Buscar Procedimento</h2>
            <p>Verifique se o procedimento já está cadastrado no sistema</p>
          </div>
        </div>

        <form [formGroup]="buscaProcedimentoForm" class="search-form">
          <div class="form-row-compact">
            <div class="form-group">
              <label>Tipo *</label>
              <select formControlName="tipo_procedimento_id" class="form-control-sm">
                <option value="">Selecione</option>
                @for (tipo of tiposProcedimento; track tipo.id) {
                  <option [value]="tipo.id">{{ tipo.sigla }} - {{ tipo.nome }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label>Número *</label>
              <input
                type="text"
                formControlName="numero"
                class="form-control-sm"
                placeholder="Ex: 123"
              >
            </div>

            <div class="form-group">
              <label>Ano *</label>
              <input
                type="number"
                formControlName="ano"
                class="form-control-sm"
                [value]="2025"
              >
            </div>

            <button
              type="button"
              class="btn-search"
              (click)="buscarProcedimento()"
              [disabled]="loadingProcedimentos"
            >
              @if (loadingProcedimentos) {
                <i class="bi bi-hourglass-split"></i>
              } @else {
                <i class="bi bi-search"></i>
              }
              Buscar
            </button>
          </div>
        </form>

        @if (procedimentoVinculado) {
          <div class="procedimento-vinculado">
            <i class="bi bi-check-circle-fill"></i>
            <span>
              Procedimento vinculado:
              <strong>
                {{ procedimentoVinculado.tipo_procedimento.sigla }}
                {{ procedimentoVinculado.numero }}/{{ procedimentoVinculado.ano }}
              </strong>
            </span>
          </div>
        }

        <div class="action-buttons">
          <button class="btn-secondary-sm" (click)="etapaAtual = 'procedimento-check'">
            <i class="bi bi-arrow-left"></i>
            Voltar
          </button>
          <button class="btn-primary-sm" (click)="irParaFormulario()">
            Continuar
            <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- ========== ETAPA 3: FORMULÁRIO PRINCIPAL ========== -->
  @if (etapaAtual === 'formulario') {

    <!-- Loading -->
    @if (isLoading) {
      <div class="loading">
        <i class="bi bi-hourglass-split"></i>
        <p>Carregando dados...</p>
      </div>
    }

    <!-- Formulário -->
    @if (!isLoading) {
      <form [formGroup]="ocorrenciaForm" (ngSubmit)="onSubmit()">

        <!-- Banner de Procedimento Vinculado -->
        @if (procedimentoVinculado) {
          <div class="info-banner">
            <i class="bi bi-link-45deg"></i>
            <span>
              Procedimento:
              <strong>
                {{ procedimentoVinculado.tipo_procedimento.sigla }}
                {{ procedimentoVinculado.numero }}/{{ procedimentoVinculado.ano }}
              </strong>
            </span>
            <button type="button" class="btn-change" (click)="voltarParaBusca()">
              <i class="bi bi-pencil"></i>
              Alterar
            </button>
          </div>
        }

        <!-- ========== SEÇÃO: IDENTIFICAÇÃO ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('identificacao')">
            <div>
              <i class="bi bi-building"></i>
              <h3>Identificação da Ocorrência</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.identificacao ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.identificacao) {
            <div class="section-content">
              <!-- Linha 1: Serviço e Unidade -->
              <div class="form-row">
                <div class="form-group required">
                  <label>Serviço Pericial</label>
                  <select
                    formControlName="servico_pericial_id"
                    [disabled]="isEditMode"
                    class="form-control"
                  >
                    <option value="">Selecione</option>
                    @for (servico of servicosPericiais; track servico.id) {
                      <option [value]="servico.id">{{ servico.sigla }} - {{ servico.nome }}</option>
                    }
                  </select>
                </div>

                <div class="form-group required">
                  <label>Unidade Demandante</label>
                  <select
                    formControlName="unidade_demandante_id"
                    class="form-control"
                    [disabled]="loadingUnidades"
                  >
                    <option value="">{{ loadingUnidades ? 'Carregando...' : 'Selecione' }}</option>
                    @for (unidade of unidadesDemandantes; track unidade.id) {
                      <option [value]="unidade.id">{{ unidade.sigla }} - {{ unidade.nome }}</option>
                    }
                  </select>
                </div>
              </div>

              <!-- Linha 2: Cargo e Autoridade -->
              <div class="form-row">
                <div class="form-group required">
                  <label>Cargo</label>
                  <select
                    [(ngModel)]="cargoSelecionado"
                    [ngModelOptions]="{standalone: true}"
                    (change)="onCargoChange()"
                    class="form-control"
                    [disabled]="loadingCargos"
                  >
                    <option value="">{{ loadingCargos ? 'Carregando...' : 'Selecione o cargo' }}</option>
                    @for (cargo of cargos; track cargo.id) {
                      <option [value]="cargo.id">{{ cargo.nome }}</option>
                    }
                  </select>
                </div>

                <div class="form-group required">
                  <label>Autoridade Requisitante</label>
                  <input
                    type="text"
                    [(ngModel)]="autoridadeBusca"
                    [ngModelOptions]="{standalone: true}"
                    (input)="buscarAutoridades()"
                    [disabled]="!cargoSelecionado"
                    class="form-control"
                    placeholder="Digite o nome da autoridade"
                  >

                  @if (mostrarResultadosAutoridade && autoridades.length > 0) {
                    <div class="autocomplete-results">
                      @for (autoridade of autoridades; track autoridade.id) {
                        <div class="autocomplete-item" (click)="selecionarAutoridade(autoridade)">
                          {{ autoridade.nome }} ({{ autoridade.cargo.nome }})
                        </div>
                      }
                    </div>
                  }

                  @if (autoridadeSelecionada) {
                    <div class="selected-badge">
                      ✓ {{ autoridadeSelecionada.nome }}
                    </div>
                  }
                </div>
              </div>

              <!-- Linha 3: Classificação -->
              <div class="form-row">
                <div class="form-group required">
                  <label>Classificação</label>
                  <select
                    formControlName="classificacao_id"
                    class="form-control"
                    [disabled]="loadingClassificacoes"
                  >
                    <option value="">{{ loadingClassificacoes ? 'Carregando...' : 'Selecione' }}</option>
                    @for (classificacao of classificacoes; track classificacao.id) {
                      <option [value]="classificacao.id">
                        {{ classificacao.codigo }} - {{ classificacao.nome }}
                      </option>
                    }
                  </select>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- ========== SEÇÃO: LOCAL E DATA DO FATO ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('local')">
            <div>
              <i class="bi bi-geo-alt"></i>
              <h3>Local e Data do Fato</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.local ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.local) {
            <div class="section-content">
              <div class="form-row">
                <div class="form-group">
                  <label>Data do Fato</label>
                  <input
                    type="date"
                    formControlName="data_fato"
                    class="form-control"
                    [readonly]="isEditMode"
                  >
                </div>

                <div class="form-group">
                  <label>Hora do Fato</label>
                  <input
                    type="time"
                    formControlName="hora_fato"
                    class="form-control"
                    [readonly]="isEditMode"
                  >
                </div>

                <div class="form-group required">
                  <label>Cidade</label>
                  <select
                    formControlName="cidade_id"
                    class="form-control"
                    [disabled]="loadingCidades"
                  >
                    <option value="">{{ loadingCidades ? 'Carregando...' : 'Selecione' }}</option>
                    @for (cidade of cidades; track cidade.id) {
                      <option [value]="cidade.id">{{ cidade.nome }}</option>
                    }
                  </select>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- ========== SEÇÃO: TIPO DE OCORRÊNCIA E ENDEREÇO ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('endereco')">
            <div>
              <i class="bi bi-pin-map"></i>
              <h3>Tipo de Ocorrência e Endereço</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.endereco ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.endereco) {
            <div class="section-content">
              <!-- Tipo de Ocorrência -->
              <div class="form-group required">
                <label>Tipo de Ocorrência</label>
                <div class="tipo-ocorrencia-toggle">
                  <label class="radio-option">
                    <input
                      type="radio"
                      name="tipo_ocorrencia"
                      [(ngModel)]="form.endereco.tipo"
                      [ngModelOptions]="{standalone: true}"
                      value="INTERNA"
                      (change)="onTipoOcorrenciaChange()">
                    <span class="radio-label">
                      <i class="bi bi-building"></i> Interna (Laboratório)
                    </span>
                  </label>

                  <label class="radio-option">
                    <input
                      type="radio"
                      name="tipo_ocorrencia"
                      [(ngModel)]="form.endereco.tipo"
                      [ngModelOptions]="{standalone: true}"
                      value="EXTERNA"
                      (change)="onTipoOcorrenciaChange()">
                    <span class="radio-label">
                      <i class="bi bi-geo-alt-fill"></i> Externa (Cena de Crime)
                    </span>
                  </label>
                </div>
              </div>

              <!-- Campos de Endereço (só aparecem se EXTERNA) -->
              @if (form.endereco.tipo === 'EXTERNA') {
                <div class="endereco-section">
                  <h5 class="section-subtitle">
                    <i class="bi bi-geo-alt"></i> Endereço da Ocorrência
                  </h5>

                  <!-- Linha 1: Logradouro, Número, Complemento -->
                  <div class="form-row">
                    <div class="form-group required" style="grid-column: span 2;">
                      <label>Logradouro</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.logradouro"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: Rua das Flores, Av. Brasil..."
                        [required]="form.endereco.tipo === 'EXTERNA'">
                    </div>

                    <div class="form-group required">
                      <label>Número</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.numero"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: 123, S/N..."
                        [required]="form.endereco.tipo === 'EXTERNA'">
                    </div>

                    <div class="form-group">
                      <label>Complemento</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.complemento"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: Apto 101, Bloco B...">
                    </div>
                  </div>

                  <!-- Linha 2: Bairro, CEP -->
                  <div class="form-row">
                    <div class="form-group required" style="grid-column: span 2;">
                      <label>Bairro</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.bairro"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: Centro, São José..."
                        [required]="form.endereco.tipo === 'EXTERNA'">
                    </div>

                    <div class="form-group">
                      <label>CEP</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.cep"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="00000-000"
                        maxlength="9">
                    </div>
                  </div>

                  <!-- Linha 3: Coordenadas Geográficas -->
                  <div class="form-row">
                    <div class="form-group">
                      <label>Latitude</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.latitude"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: -23.550520">
                      <small class="form-hint">Opcional - Para geolocalização</small>
                    </div>

                    <div class="form-group">
                      <label>Longitude</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.longitude"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: -46.633308">
                      <small class="form-hint">Opcional - Para geolocalização</small>
                    </div>
                  </div>

                  <!-- Linha 4: Ponto de Referência -->
                  <div class="form-row">
                    <div class="form-group" style="grid-column: span 3;">
                      <label>Ponto de Referência</label>
                      <input
                        type="text"
                        [(ngModel)]="form.endereco.ponto_referencia"
                        [ngModelOptions]="{standalone: true}"
                        class="form-control"
                        placeholder="Ex: Próximo ao hospital, em frente à escola...">
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- ========== SEÇÃO: DOCUMENTAÇÃO ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('documentacao')">
            <div>
              <i class="bi bi-file-earmark-text"></i>
              <h3>Documentação (Opcional)</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.documentacao ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.documentacao) {
            <div class="section-content">
              <div class="form-row">
                <div class="form-group">
                  <label>Tipo de Documento</label>
                  <select formControlName="tipo_documento_origem_id" class="form-control">
                    <option value="">Selecione</option>
                    @for (tipo of tiposDocumento; track tipo.id) {
                      <option [value]="tipo.id">{{ tipo.nome }}</option>
                    }
                  </select>
                </div>

                <div class="form-group">
                  <label>Número do Documento</label>
                  <input
                    type="text"
                    formControlName="numero_documento_origem"
                    class="form-control"
                    placeholder="Ex: 123/2025"
                  >
                </div>

                <div class="form-group">
                  <label>Data do Documento</label>
                  <input
                    type="date"
                    formControlName="data_documento_origem"
                    class="form-control"
                  >
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Processo SEI</label>
                  <input
                    type="text"
                    formControlName="processo_sei_numero"
                    class="form-control"
                    placeholder="Ex: 12345.678910/2025-11"
                  >
                </div>
              </div>
            </div>
          }
        </div>

        <!-- ========== SEÇÃO: ATRIBUIÇÃO DE PERITO ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('atribuicao')">
            <div>
              <i class="bi bi-person-badge"></i>
              <h3>Atribuição de Perito (Opcional)</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.atribuicao ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.atribuicao) {
            <div class="section-content">
              <div class="form-row">
                <div class="form-group">
                  <label>Perito</label>
                  <select formControlName="perito_atribuido_id" class="form-control">
                    <option value="">Atribuir posteriormente</option>
                    @for (perito of peritos; track perito.id) {
                      <option [value]="perito.id">{{ perito.nome_completo }}</option>
                    }
                  </select>
                  <small class="form-hint">Deixe em branco para atribuir depois</small>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- ========== SEÇÃO: EXAMES ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('exames')">
            <div>
              <i class="bi bi-clipboard-pulse"></i>
              <h3>Exames Solicitados ({{ examesSelecionados.length }})</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.exames ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.exames) {
            <div class="section-content">
              <button type="button" class="btn-add-exame" (click)="abrirModalExames()">
                <i class="bi bi-plus-circle"></i>
                Adicionar Exames
              </button>

              @if (examesSelecionados.length > 0) {
                <div class="exames-list">
                  @for (exame of examesSelecionados; track exame.id) {
                    <div class="exame-tag">
                      <span>
                        <strong>{{ exame.codigo }}</strong> - {{ exame.nome }}
                      </span>
                      <button type="button" class="btn-remove-exame" (click)="removerExame(exame)">
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  }
                </div>
              } @else {
                <p class="text-muted-small">Nenhum exame selecionado</p>
              }
            </div>
          }
        </div>

        <!-- ========== SEÇÃO: OBSERVAÇÕES ========== -->
        <div class="form-section">
          <div class="section-header" (click)="toggleSecao('observacoes')">
            <div>
              <i class="bi bi-chat-left-text"></i>
              <h3>Histórico / Observações</h3>
            </div>
            <i class="bi" [ngClass]="secoesAbertas.observacoes ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </div>

          @if (secoesAbertas.observacoes) {
            <div class="section-content">
              <div class="form-group">
                <textarea
                  formControlName="historico"
                  class="form-control-textarea"
                  rows="5"
                  placeholder="Descreva o histórico ou observações relevantes sobre a ocorrência..."
                ></textarea>
                <small class="form-hint">
                  Este campo pode ser editado dentro de 72 horas após o cadastro
                </small>
              </div>
            </div>
          }
        </div>

        <!-- ========== BOTÕES DE AÇÃO ========== -->
        <div class="form-actions">
          <button type="button" class="btn-cancel-form" (click)="cancelar()">
            Cancelar
          </button>
          <button
            type="submit"
            class="btn-submit"
            [disabled]="isSaving || ocorrenciaForm.invalid"
          >
            @if (isSaving) {
              <i class="bi bi-hourglass-split"></i>
              Salvando...
            } @else {
              <i class="bi bi-check-circle"></i>
              {{ isEditMode ? 'Atualizar' : 'Cadastrar' }} Ocorrência
            }
          </button>
        </div>
      </form>
    }
  }

  <!-- ========== MODAL DE SELEÇÃO DE EXAMES ========== -->
  <app-exame-selector-modal
    [isOpen]="modalExamesAberto"
    [examesDisponiveis]="examesDisponiveis"
    [examesPreSelecionados]="examesSelecionados"
    (onConfirm)="onExamesConfirmados($event)"
    (onClose)="modalExamesAberto = false"
  ></app-exame-selector-modal>
</div>
