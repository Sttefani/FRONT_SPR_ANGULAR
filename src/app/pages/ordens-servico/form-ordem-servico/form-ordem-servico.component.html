<!-- src/app/pages/ordens-servico/form-ordem-servico/form-ordem-servico.component.html -->

<div class="container-fluid py-4">
  <!-- CABE√áALHO -->
  <div class="mb-4">
    <h2 class="mb-1">üìã Nova Ordem de Servi√ßo</h2>
    <p class="text-muted mb-0">Preencha os dados abaixo para emitir uma nova OS</p>
  </div>

  <!-- MENSAGEM DE ERRO -->
  <div class="alert alert-danger" *ngIf="error">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- FORMUL√ÅRIO PRINCIPAL -->
  <div class="card" *ngIf="!mostrarAssinatura">
    <div class="card-body">
      <form>
        <!-- BUSCA DE OCORR√äNCIA -->
        <div class="row g-3 mb-4">
          <div class="col-12">
            <h5 class="border-bottom pb-2 mb-3">üîç Buscar Ocorr√™ncia</h5>
          </div>

          <div class="col-12">
            <label class="form-label">N√∫mero da Ocorr√™ncia <span class="text-danger">*</span></label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                [(ngModel)]="numeroOcorrenciaBusca"
                name="buscaOcorrencia"
                placeholder="Ex: 20250001/PLT"
                [disabled]="ocorrenciaEncontrada !== null"
                (keyup.enter)="buscarOcorrencia()">

              <button
                class="btn btn-primary"
                type="button"
                (click)="buscarOcorrencia()"
                [disabled]="buscandoOcorrencia || ocorrenciaEncontrada !== null">
                <span *ngIf="!buscandoOcorrencia">
                  <i class="bi bi-search"></i> Buscar
                </span>
                <span *ngIf="buscandoOcorrencia">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Buscando...
                </span>
              </button>

              <button
                class="btn btn-outline-secondary"
                type="button"
                (click)="limparBusca()"
                *ngIf="ocorrenciaEncontrada !== null">
                <i class="bi bi-x-lg"></i> Limpar
              </button>
            </div>

            <!-- ERRO -->
            <div class="alert alert-danger mt-2 mb-0" *ngIf="erroOcorrencia">
              <i class="bi bi-exclamation-triangle"></i> {{ erroOcorrencia }}
            </div>

            <!-- SUCESSO -->
            <div class="alert alert-success mt-2 mb-0" *ngIf="ocorrenciaEncontrada">
              <h6 class="alert-heading">
                <i class="bi bi-check-circle"></i> Ocorr√™ncia Encontrada!
              </h6>
              <hr>
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong>N√∫mero:</strong> {{ ocorrenciaEncontrada.numero_ocorrencia }}</p>
                  <p class="mb-1"><strong>Servi√ßo:</strong> {{ ocorrenciaEncontrada.servico_pericial?.nome || '-' }}</p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><strong>Perito:</strong> {{ ocorrenciaEncontrada.perito_atribuido?.nome_completo || '-' }}</p>
                  <p class="mb-0"><strong>Status:</strong> {{ ocorrenciaEncontrada.status }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- DADOS PRINCIPAIS (S√ì APARECE DEPOIS DE ENCONTRAR) -->
        <div *ngIf="ocorrenciaEncontrada">
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h5 class="border-bottom pb-2 mb-3">üìÑ Dados da Ordem de Servi√ßo</h5>
            </div>

            <!-- Prazo -->
            <div class="col-md-6">
              <label class="form-label">Prazo (dias) <span class="text-danger">*</span></label>
              <input
                type="number"
                class="form-control"
                [(ngModel)]="form.prazo_dias"
                name="prazo"
                min="1"
                max="365"
                placeholder="Ex: 10">
              <small class="form-text text-muted">
                Prazo padr√£o: 10 dias
              </small>
            </div>

            <!-- Ordenada por -->
            <div class="col-md-6">
              <label class="form-label">Ordenada por <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="form.ordenada_por_id" name="ordenada_por">
                <option [value]="undefined">Selecione</option>
                <option *ngFor="let user of usuarios" [value]="user.id">
                  {{ user.nome_completo }}
                </option>
              </select>
              <small class="form-text text-muted">
                Diretor/Chefe respons√°vel
              </small>
            </div>
          </div>

          <!-- DOCUMENTOS DE REFER√äNCIA -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h5 class="border-bottom pb-2 mb-3">üìé Documentos de Refer√™ncia (Opcional)</h5>
            </div>

            <!-- Tipo de Documento -->
            <div class="col-md-6">
              <label class="form-label">Tipo de Documento</label>
              <select
                class="form-select"
                [(ngModel)]="form.tipo_documento_referencia_id"
                name="tipo_doc">
                <option [value]="undefined">Nenhum</option>
                <option *ngFor="let tipo of tiposDocumento" [value]="tipo.id">
                  {{ tipo.nome }}
                </option>
              </select>
            </div>

            <!-- N√∫mero do Documento -->
            <div class="col-md-6">
              <label class="form-label">N√∫mero do Documento</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="form.numero_documento_referencia"
                name="num_doc"
                placeholder="Ex: OF/001/2025">
            </div>

            <!-- Processo SEI -->
            <div class="col-md-6">
              <label class="form-label">Processo SEI</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="form.processo_sei_referencia"
                name="sei"
                placeholder="Ex: 23080.123456/2025-78">
            </div>

            <!-- Processo Judicial -->
            <div class="col-md-6">
              <label class="form-label">Processo Judicial</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="form.processo_judicial_referencia"
                name="judicial"
                placeholder="Ex: 0001234-56.2025.8.23.0001">
            </div>
          </div>

          <!-- OBSERVA√á√ïES -->
          <div class="row g-3 mb-4">
            <div class="col-12">
              <h5 class="border-bottom pb-2 mb-3">üí¨ Observa√ß√µes</h5>
            </div>

            <div class="col-12">
              <label class="form-label">Observa√ß√µes Internas</label>
              <textarea
                class="form-control"
                rows="4"
                [(ngModel)]="form.observacoes_administrativo"
                name="obs"
                placeholder="Observa√ß√µes internas do administrativo (n√£o aparecem no PDF oficial)"></textarea>
              <small class="form-text text-muted">
                Estas observa√ß√µes s√£o apenas para controle interno
              </small>
            </div>
          </div>

          <!-- BOT√ïES -->
          <div class="d-flex justify-content-end gap-2">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="cancelar()">
              <i class="bi bi-x-lg"></i> Cancelar
            </button>

            <button
              type="button"
              class="btn btn-primary"
              (click)="prepararAssinatura()">
              <i class="bi bi-arrow-right"></i> Continuar para Assinatura
            </button>
          </div>
        </div>

        <!-- MENSAGEM SE N√ÉO BUSCOU AINDA -->
        <div *ngIf="!ocorrenciaEncontrada" class="text-center py-5">
          <i class="bi bi-search display-1 text-muted"></i>
          <h5 class="mt-3 text-muted">Busque uma ocorr√™ncia para come√ßar</h5>
          <p class="text-muted">Digite o n√∫mero da ocorr√™ncia acima e clique em "Buscar"</p>
        </div>
      </form>
    </div>
  </div>

  <!-- CONFIRMA√á√ÉO COM ASSINATURA DIGITAL -->
  <div class="card border-primary" *ngIf="mostrarAssinatura">
    <div class="card-header bg-primary text-white">
      <h5 class="card-title mb-0">
        <i class="bi bi-shield-lock"></i> Assinatura Digital
      </h5>
    </div>

    <div class="card-body">
      <!-- RESUMO DA OS -->
      <div class="alert alert-info">
        <h6 class="alert-heading">üìã Resumo da Ordem de Servi√ßo</h6>
        <hr>
        <div class="row">
          <div class="col-md-6">
            <p class="mb-1"><strong>Ocorr√™ncia:</strong> {{ ocorrenciaEncontrada?.numero_ocorrencia }}</p>
            <p class="mb-1"><strong>Perito:</strong> {{ ocorrenciaEncontrada?.perito_atribuido?.nome_completo }}</p>
            <p class="mb-1"><strong>Prazo:</strong> {{ form.prazo_dias }} dia(s)</p>
          </div>
          <div class="col-md-6">
            <p class="mb-1">
              <strong>Processo SEI:</strong>
              {{ form.processo_sei_referencia || '-' }}
            </p>
            <p class="mb-0">
              <strong>Documento Ref.:</strong>
              {{ form.numero_documento_referencia || '-' }}
            </p>
          </div>
        </div>
      </div>

      <!-- ASSINATURA -->
      <form>
        <div class="row g-3">
          <div class="col-12">
            <p class="text-muted mb-3">
              Para emitir esta Ordem de Servi√ßo, confirme sua identidade:
            </p>
          </div>

          <div class="col-md-6">
            <label class="form-label">Email de Confirma√ß√£o <span class="text-danger">*</span></label>
            <input
              type="email"
              class="form-control"
              [(ngModel)]="emailConfirmacao"
              name="email"
              placeholder="seu@email.com"
              autocomplete="email">
          </div>

          <div class="col-md-6">
            <label class="form-label">Senha <span class="text-danger">*</span></label>
            <input
              type="password"
              class="form-control"
              [(ngModel)]="senhaConfirmacao"
              name="senha"
              placeholder="Digite sua senha"
              autocomplete="current-password"
              (keyup.enter)="confirmarCriacao()">
          </div>
        </div>

        <div class="alert alert-warning mt-3">
          <small>
            <i class="bi bi-info-circle"></i>
            <strong>Aten√ß√£o:</strong> Ao confirmar, voc√™ estar√° assinando digitalmente esta Ordem de Servi√ßo.
            O perito ser√° notificado e o documento ficar√° registrado no sistema.
          </small>
        </div>

        <!-- BOT√ïES -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="voltarParaFormulario()"
            [disabled]="loading">
            <i class="bi bi-arrow-left"></i> Voltar
          </button>

          <button
            type="button"
            class="btn btn-success btn-lg"
            (click)="confirmarCriacao()"
            [disabled]="loading || !emailConfirmacao || !senhaConfirmacao">
            <span *ngIf="!loading">
              <i class="bi bi-check-circle"></i> Confirmar e Emitir OS
            </span>
            <span *ngIf="loading">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Emitindo...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
