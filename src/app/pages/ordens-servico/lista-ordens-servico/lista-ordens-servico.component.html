<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 header-card">
    <div>
      <h2 class="mb-1">üìã Ordens de Servi√ßo</h2>
      <p class="text-muted mb-0">
        <span *ngIf="!loading && totalItens > 0">
          Mostrando {{ getIndicePrimeiro() }}-{{ getIndiceUltimo() }} de {{ totalItens }} registro(s)
        </span>
        <span *ngIf="!loading && totalItens === 0">Nenhum registro encontrado</span>
        <span *ngIf="loading">Carregando...</span>
      </p>
    </div>

    <div class="d-flex gap-2">
      <button
        class="btn btn-outline-secondary"
        (click)="alternarModoExibicao()"
        title="Alternar visualiza√ß√£o">
        <i class="bi" [class.bi-grid]="modoExibicao === 'tabela'" [class.bi-list]="modoExibicao === 'cards'"></i>
      </button>

      @if (isAdministrativo()) {
        <button
          class="btn btn-primary"
          (click)="novaOrdemServico()">
          <i class="bi bi-plus-lg"></i> Nova OS
        </button>
      }
    </div>
  </div>

  <!-- ‚úÖ FILTROS SIMPLIFICADOS -->
  <div class="filtros-simplificados mb-3" *ngIf="!loading">
    <div class="row g-3 align-items-end">
      <!-- Busca por n√∫mero -->
      <div class="col-md-4">
        <label class="form-label">üîç Buscar</label>
        <input
          type="text"
          class="form-control"
          [(ngModel)]="filtros.search"
          placeholder="N¬∫ da OS ou Ocorr√™ncia"
          (keyup.enter)="aplicarFiltros()">
      </div>

      <!-- Filtro por perito (apenas para administrativos) -->
      <div class="col-md-4" *ngIf="isAdministrativo()">
        <label class="form-label">üë§ Perito</label>
        <select
          class="form-select"
          [(ngModel)]="filtros.perito_id"
          (change)="aplicarFiltros()">
          <option value="">Todos os peritos</option>
          <option *ngFor="let perito of peritos" [value]="perito.id">
            {{ perito.nome_completo }}
          </option>
        </select>
      </div>

      <!-- Bot√µes de a√ß√£o -->
      <div class="col-md-4">
        <div class="d-flex gap-2">
          <button
            class="btn btn-primary flex-fill"
            (click)="aplicarFiltros()"
            [disabled]="!filtros.search && !filtros.perito_id">
            <i class="bi bi-search"></i> Buscar
          </button>

          <button
            class="btn btn-outline-secondary"
            (click)="limparFiltros()"
            *ngIf="filtros.search || filtros.perito_id">
            <i class="bi bi-x-circle"></i> Limpar
          </button>

          <button
            class="btn btn-outline-primary"
            (click)="toggleFiltros()"
            title="Filtros avan√ßados">
            <i class="bi bi-funnel"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAINEL DE FILTROS AVAN√áADOS -->
  <div class="card mb-4" *ngIf="mostrarFiltros">
    <div class="card-body">
      <h5 class="card-title mb-3">üîç Filtros Avan√ßados</h5>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" [(ngModel)]="filtros.status">
            <option *ngFor="let opt of statusOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Urg√™ncia</label>
          <select class="form-select" [(ngModel)]="filtros.urgencia">
            <option *ngFor="let opt of urgenciaOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <div class="col-md-3" *ngIf="isAdministrativo()">
          <label class="form-label">Unidade Demandante</label>
          <select class="form-select" [(ngModel)]="filtros.unidade_id">
            <option value="">Todas as unidades</option>
            <option *ngFor="let unidade of unidades" [value]="unidade.id">
              {{ unidade.nome }}
            </option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Emitida a partir de</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="filtros.data_inicio">
        </div>

        <div class="col-md-3">
          <label class="form-label">Emitida at√©</label>
          <input
            type="date"
            class="form-control"
            [(ngModel)]="filtros.data_fim">
        </div>

        <div class="col-md-3">
          <label class="form-label">Situa√ß√µes especiais</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="filtroVencida"
              [(ngModel)]="filtros.vencida">
            <label class="form-check-label" for="filtroVencida">
              Apenas vencidas
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="filtroSemCiencia"
              [(ngModel)]="filtros.sem_ciencia">
            <label class="form-check-label" for="filtroSemCiencia">
              Sem ci√™ncia
            </label>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary" (click)="aplicarFiltros()">
          <i class="bi bi-search"></i> Aplicar Filtros
        </button>
        <button class="btn btn-outline-secondary" (click)="limparFiltros()">
          <i class="bi bi-x-lg"></i> Limpar Todos
        </button>
      </div>
    </div>
  </div>

  <!-- ERRO -->
  <div class="alert alert-danger" *ngIf="error">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- LOADING -->
  <div class="text-center py-5" *ngIf="loading">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-3 text-muted fw-bold">Carregando ordens de servi√ßo...</p>
  </div>

  <!-- EMPTY STATE -->
  <div class="text-center py-5 empty-state" *ngIf="!loading && ordensServico.length === 0">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h4 class="mt-3">Nenhuma ordem de servi√ßo encontrada</h4>
    <p class="text-muted">Tente ajustar os filtros ou criar uma nova OS.</p>
    <button class="btn btn-outline-primary mt-2" (click)="limparFiltros()">
      <i class="bi bi-arrow-clockwise"></i> Limpar Filtros
    </button>
  </div>

  <!-- CONTROLES DE VISUALIZA√á√ÉO -->
  <div class="controles-visualizacao mb-3" *ngIf="!loading && ordensServico.length > 0">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <label class="mb-0 text-muted small">Mostrar:</label>
        <select
          class="form-select form-select-sm"
          style="width: auto;"
          [(ngModel)]="itensPorPagina"
          (change)="mudarQuantidadePorPagina()">
          <option *ngFor="let qtd of quantidadeOptions" [value]="qtd">
            {{ qtd }} por p√°gina
          </option>
        </select>
      </div>

      <div class="text-muted small">
        <strong>{{ getIndicePrimeiro() }}-{{ getIndiceUltimo() }}</strong> de <strong>{{ totalItens }}</strong> registros
      </div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="card table-card" *ngIf="!loading && ordensServico.length > 0 && modoExibicao === 'tabela'">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th (click)="ordenarColuna('numero_os')" class="sortable">
              N¬∫ OS
              <i class="bi ms-1" [ngClass]="getIconeOrdenacao('numero_os')"></i>
            </th>
            <th>Ocorr√™ncia</th>
            <th>Perito</th>
            <th (click)="ordenarColuna('status')" class="sortable">
              Status
              <i class="bi ms-1" [ngClass]="getIconeOrdenacao('status')"></i>
            </th>
            <th (click)="ordenarColuna('urgencia')" class="sortable">
              Urg√™ncia
              <i class="bi ms-1" [ngClass]="getIconeOrdenacao('urgencia')"></i>
            </th>
            <th (click)="ordenarColuna('prazo_dias')" class="sortable">
              Prazo
              <i class="bi ms-1" [ngClass]="getIconeOrdenacao('prazo_dias')"></i>
            </th>
            <th (click)="ordenarColuna('dias_restantes')" class="sortable">
              Restante
              <i class="bi ms-1" [ngClass]="getIconeOrdenacao('dias_restantes')"></i>
            </th>
            <th>A√ß√£o Necess√°ria</th>
            <th class="text-center acoes-header">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let os of ordensServico">
            <td>
              <strong>{{ os.numero_os }}</strong>
              <span class="badge bg-info ms-1" *ngIf="os.numero_reiteracao > 0">
                {{ os.numero_reiteracao }}¬™ Reit.
              </span>
            </td>

            <td>
              <small class="text-muted">{{ os.ocorrencia.numero_ocorrencia }}</small>
            </td>

            <td>
              <small *ngIf="os.perito_destinatario">
                {{ os.perito_destinatario.nome_completo }}
              </small>
              <small class="text-muted" *ngIf="!os.perito_destinatario">-</small>
            </td>

            <td>
              <span class="badge bg-{{ getStatusColor(os.status) }}">
                {{ getStatusLabel(os.status) }}
              </span>
            </td>

            <td>
              <span
                class="badge bg-{{ getUrgenciaInfo(os.urgencia).cor }}"
                *ngIf="os.urgencia">
                {{ getUrgenciaInfo(os.urgencia).icone }} {{ getUrgenciaInfo(os.urgencia).label }}
              </span>
              <span class="badge bg-secondary" *ngIf="!os.urgencia">
                üîí Sem Ci√™ncia
              </span>
            </td>

            <td>
              <small>{{ os.prazo_dias }} dia(s)</small>
            </td>

            <td>
              <small
                [class.text-danger]="os.dias_restantes !== null && os.dias_restantes < 0"
                [class.text-warning]="os.dias_restantes !== null && os.dias_restantes >= 0 && os.dias_restantes <= 2"
                [class.fw-bold]="os.dias_restantes !== null && os.dias_restantes <= 2">
                {{ getDiasRestantesTexto(os) }}
              </small>
            </td>

            <td>
              <span class="badge badge-acao bg-warning text-dark" *ngIf="os.acao_necessaria === 'TOMAR_CIENCIA'">
                ‚ö†Ô∏è Dar Ci√™ncia
              </span>
              <span class="badge badge-acao bg-info" *ngIf="os.acao_necessaria === 'INICIAR_TRABALHO'">
                ‚ñ∂Ô∏è Iniciar
              </span>
              <span class="badge badge-acao bg-danger" *ngIf="os.acao_necessaria === 'JUSTIFICAR_ATRASO'">
                ‚ö†Ô∏è Justificar
              </span>
              <span class="badge badge-acao bg-warning" *ngIf="os.acao_necessaria === 'REITERAR'">
                üîÑ Reiterar
              </span>
            </td>

            <td class="text-center acoes-coluna">
              <div class="d-flex gap-1 justify-content-center">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  (click)="verDetalhes(os)"
                  title="Ver detalhes">
                  <i class="bi bi-eye"></i>
                </button>

                <button
                  type="button"
                  class="btn btn-sm btn-success"
                  (click)="tomarCiencia(os)"
                  *ngIf="os.acao_necessaria === 'TOMAR_CIENCIA'"
                  title="Tomar ci√™ncia">
                  <i class="bi bi-check2-circle"></i>
                </button>

                <button
                  type="button"
                  class="btn btn-sm btn-info"
                  (click)="iniciarTrabalho(os)"
                  *ngIf="os.acao_necessaria === 'INICIAR_TRABALHO'"
                  title="Iniciar trabalho">
                  <i class="bi bi-play-circle"></i>
                </button>

                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  (click)="baixarPdf(os)"
                  title="Baixar PDF">
                  <i class="bi bi-file-pdf"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODO CARDS -->
  <div class="row g-3" *ngIf="!loading && ordensServico.length > 0 && modoExibicao === 'cards'">
    <div class="col-md-6 col-lg-4" *ngFor="let os of ordensServico">
      <div class="card h-100 shadow-sm card-os">
        <div class="card-header bg-{{ getStatusColor(os.status) }} text-white">
          <div class="d-flex justify-content-between align-items-center">
            <strong>{{ os.numero_os }}</strong>
            <span class="badge bg-light text-dark" *ngIf="os.numero_reiteracao > 0">
              {{ os.numero_reiteracao }}¬™ Reitera√ß√£o
            </span>
          </div>
        </div>

        <div class="card-body">
          <p class="mb-2">
            <strong>Ocorr√™ncia:</strong> {{ os.ocorrencia.numero_ocorrencia }}
          </p>

          <p class="mb-2" *ngIf="os.perito_destinatario">
            <strong>Perito:</strong> {{ os.perito_destinatario.nome_completo }}
          </p>

          <p class="mb-2">
            <strong>Status:</strong>
            <span class="badge bg-{{ getStatusColor(os.status) }} ms-2">
              {{ getStatusLabel(os.status) }}
            </span>
          </p>

          <p class="mb-2">
            <strong>Urg√™ncia:</strong>
            <span
              class="badge bg-{{ getUrgenciaInfo(os.urgencia).cor }} ms-2"
              *ngIf="os.urgencia">
              {{ getUrgenciaInfo(os.urgencia).icone }} {{ getUrgenciaInfo(os.urgencia).label }}
            </span>
            <span class="badge bg-secondary ms-2" *ngIf="!os.urgencia">
              üîí Sem Ci√™ncia
            </span>
          </p>

          <p class="mb-2">
            <strong>Prazo:</strong> {{ os.prazo_dias }} dia(s)
          </p>

          <p class="mb-0">
            <strong>Restante:</strong>
            <span
              [class.text-danger]="os.dias_restantes !== null && os.dias_restantes < 0"
              [class.text-warning]="os.dias_restantes !== null && os.dias_restantes >= 0 && os.dias_restantes <= 2"
              [class.fw-bold]="os.dias_restantes !== null && os.dias_restantes <= 2">
              {{ getDiasRestantesTexto(os) }}
            </span>
          </p>

          <div class="progress mt-3" style="height: 8px;" *ngIf="os.percentual_prazo_consumido > 0">
            <div
              class="progress-bar"
              [class.bg-success]="os.percentual_prazo_consumido <= 50"
              [class.bg-warning]="os.percentual_prazo_consumido > 50 && os.percentual_prazo_consumido <= 80"
              [class.bg-danger]="os.percentual_prazo_consumido > 80"
              [style.width.%]="os.percentual_prazo_consumido">
            </div>
          </div>
        </div>

        <div class="card-footer bg-light">
          <div class="d-grid gap-2">
            <button
              type="button"
              class="btn btn-sm btn-primary"
              (click)="verDetalhes(os)">
              <i class="bi bi-eye"></i> Ver Detalhes
            </button>

            <button
              type="button"
              class="btn btn-sm btn-success"
              (click)="tomarCiencia(os)"
              *ngIf="os.acao_necessaria === 'TOMAR_CIENCIA'">
              <i class="bi bi-check2-circle"></i> Tomar Ci√™ncia
            </button>

            <button
              type="button"
              class="btn btn-sm btn-info"
              (click)="iniciarTrabalho(os)"
              *ngIf="os.acao_necessaria === 'INICIAR_TRABALHO'">
              <i class="bi bi-play-circle"></i> Iniciar Trabalho
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGINA√á√ÉO -->
  <nav aria-label="Pagina√ß√£o" *ngIf="!loading && ordensServico.length > 0 && totalPaginas > 1" class="mt-4">
    <div class="paginacao-container">
      <ul class="pagination justify-content-center mb-0">
        <li class="page-item" [class.disabled]="paginaAtual === 1">
          <a class="page-link" (click)="irParaPagina(1)" title="Primeira p√°gina">
            <i class="bi bi-chevron-double-left"></i>
          </a>
        </li>

        <li class="page-item" [class.disabled]="paginaAtual === 1">
          <a class="page-link" (click)="irParaPagina(paginaAtual - 1)">
            <i class="bi bi-chevron-left"></i> Anterior
          </a>
        </li>

        <li
          class="page-item"
          *ngFor="let pagina of getPaginas()"
          [class.active]="pagina === paginaAtual">
          <a class="page-link" (click)="irParaPagina(pagina)">
            {{ pagina }}
          </a>
        </li>

        <li class="page-item" [class.disabled]="paginaAtual === totalPaginas">
          <a class="page-link" (click)="irParaPagina(paginaAtual + 1)">
            Pr√≥xima <i class="bi bi-chevron-right"></i>
          </a>
        </li>

        <li class="page-item" [class.disabled]="paginaAtual === totalPaginas">
          <a class="page-link" (click)="irParaPagina(totalPaginas)" title="√öltima p√°gina">
            <i class="bi bi-chevron-double-right"></i>
          </a>
        </li>
      </ul>

      <div class="ir-para-pagina mt-3">
        <div class="d-flex justify-content-center align-items-center gap-2">
          <label class="mb-0 small text-muted">Ir para p√°gina:</label>
          <input
            type="number"
            class="form-control form-control-sm"
            style="width: 80px;"
            [(ngModel)]="paginaInput"
            [min]="1"
            [max]="totalPaginas"
            (keyup.enter)="irParaPaginaDigitada()">
          <button
            class="btn btn-sm btn-outline-primary"
            (click)="irParaPaginaDigitada()">
            <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>
</div>
