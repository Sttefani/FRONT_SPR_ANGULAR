<!-- src/app/pages/ordens-servico/lista-ordens-servico/lista-ordens-servico.component.html -->

<div class="container-fluid py-4">
  <!-- CABEÃ‡ALHO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">ğŸ“‹ Ordens de ServiÃ§o</h2>
      <p class="text-muted mb-0">
        <span *ngIf="!loading">{{ totalItens }} registro(s) encontrado(s)</span>
        <span *ngIf="loading">Carregando...</span>
      </p>
    </div>

    <div class="d-flex gap-2">
      <button
        class="btn btn-outline-primary"
        (click)="toggleFiltros()"
        [class.active]="mostrarFiltros">
        <i class="bi bi-funnel"></i> Filtros
      </button>

      <button
        class="btn btn-outline-secondary"
        (click)="alternarModoExibicao()"
        title="Alternar visualizaÃ§Ã£o">
        <i class="bi" [class.bi-grid]="modoExibicao === 'tabela'" [class.bi-list]="modoExibicao === 'cards'"></i>
      </button>

 @if (isAdministrativo()) {
  <button
    class="btn btn-primary"
    (click)="novaOrdemServico()">
    <i class="bi bi-plus-lg"></i> Nova OS
  </button>
}
    </div>
  </div>

  <!-- PAINEL DE FILTROS -->
  <div class="card mb-4" *ngIf="mostrarFiltros">
    <div class="card-body">
      <h5 class="card-title mb-3">ğŸ” Filtros</h5>

      <div class="row g-3">
        <!-- Busca -->
        <div class="col-md-4">
          <label class="form-label">Buscar por NÂº OS ou OcorrÃªncia</label>
          <input
            type="text"
            class="form-control"
            [(ngModel)]="filtros.search"
            placeholder="Ex: 0001/2025"
            (keyup.enter)="aplicarFiltros()">
        </div>

        <!-- Status -->
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" [(ngModel)]="filtros.status">
            <option *ngFor="let opt of statusOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <!-- UrgÃªncia -->
        <div class="col-md-3">
          <label class="form-label">UrgÃªncia</label>
          <select class="form-select" [(ngModel)]="filtros.urgencia">
            <option *ngFor="let opt of urgenciaOptions" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>
        </div>

        <!-- Vencida -->
        <div class="col-md-2">
          <label class="form-label">SituaÃ§Ã£o</label>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="filtroVencida"
              [(ngModel)]="filtros.vencida">
            <label class="form-check-label" for="filtroVencida">
              Apenas vencidas
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="filtroSemCiencia"
              [(ngModel)]="filtros.sem_ciencia">
            <label class="form-check-label" for="filtroSemCiencia">
              Sem ciÃªncia
            </label>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary" (click)="aplicarFiltros()">
          <i class="bi bi-search"></i> Aplicar Filtros
        </button>
        <button class="btn btn-outline-secondary" (click)="limparFiltros()">
          <i class="bi bi-x-lg"></i> Limpar
        </button>
      </div>
    </div>
  </div>

  <!-- MENSAGEM DE ERRO -->
  <div class="alert alert-danger" *ngIf="error">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- LOADING -->
  <div class="text-center py-5" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2 text-muted">Carregando ordens de serviÃ§o...</p>
  </div>

  <!-- LISTA VAZIA -->
  <div class="text-center py-5" *ngIf="!loading && ordensServico.length === 0">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h4 class="mt-3">Nenhuma ordem de serviÃ§o encontrada</h4>
    <p class="text-muted">Tente ajustar os filtros ou criar uma nova OS.</p>
  </div>

  <!-- MODO TABELA -->
  <div class="card" *ngIf="!loading && ordensServico.length > 0 && modoExibicao === 'tabela'">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>NÂº OS</th>
            <th>OcorrÃªncia</th>
            <th>Perito</th>
            <th>Status</th>
            <th>UrgÃªncia</th>
            <th>Prazo</th>
            <th>Restante</th>
            <th>AÃ§Ã£o NecessÃ¡ria</th>
            <th class="text-center">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let os of ordensServico">
            <!-- NÃºmero OS -->
            <td>
              <strong>{{ os.numero_os }}</strong>
              <span class="badge bg-info ms-1" *ngIf="os.numero_reiteracao > 0">
                {{ os.numero_reiteracao }}Âª Reit.
              </span>
            </td>

            <!-- OcorrÃªncia -->
            <td>
              <small class="text-muted">{{ os.ocorrencia.numero_ocorrencia }}</small>
            </td>

            <!-- Perito -->
            <td>
              <small *ngIf="os.perito_destinatario">
                {{ os.perito_destinatario.nome_completo }}
              </small>
              <small class="text-muted" *ngIf="!os.perito_destinatario">-</small>
            </td>

            <!-- Status -->
            <td>
              <span class="badge bg-{{ getStatusColor(os.status) }}">
                {{ getStatusLabel(os.status) }}
              </span>
            </td>

            <!-- UrgÃªncia -->
            <td>
              <span
                class="badge bg-{{ getUrgenciaInfo(os.urgencia).cor }}"
                *ngIf="os.urgencia">
                {{ getUrgenciaInfo(os.urgencia).icone }} {{ getUrgenciaInfo(os.urgencia).label }}
              </span>
              <span class="badge bg-secondary" *ngIf="!os.urgencia">
                ğŸ”’ Sem CiÃªncia
              </span>
            </td>

            <!-- Prazo -->
            <td>
              <small>{{ os.prazo_dias }} dia(s)</small>
            </td>

            <!-- Restante -->
            <td>
              <small
                [class.text-danger]="os.dias_restantes !== null && os.dias_restantes < 0"
                [class.text-warning]="os.dias_restantes !== null && os.dias_restantes >= 0 && os.dias_restantes <= 2"
                [class.fw-bold]="os.dias_restantes !== null && os.dias_restantes <= 2">
                {{ getDiasRestantesTexto(os) }}
              </small>
            </td>

            <!-- AÃ§Ã£o NecessÃ¡ria -->
            <td>
              <span class="badge bg-warning text-dark" *ngIf="os.acao_necessaria === 'TOMAR_CIENCIA'">
                âš ï¸ Dar CiÃªncia
              </span>
              <span class="badge bg-info" *ngIf="os.acao_necessaria === 'INICIAR_TRABALHO'">
                â–¶ï¸ Iniciar
              </span>
              <span class="badge bg-danger" *ngIf="os.acao_necessaria === 'JUSTIFICAR_ATRASO'">
                âš ï¸ Justificar
              </span>
              <span class="badge bg-warning" *ngIf="os.acao_necessaria === 'REITERAR'">
                ğŸ”„ Reiterar
              </span>
            </td>

            <!-- AÃ§Ãµes -->
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <button
                  class="btn btn-outline-primary"
                  (click)="verDetalhes(os)"
                  title="Ver detalhes">
                  <i class="bi bi-eye"></i>
                </button>

                <button
                  class="btn btn-outline-success"
                  (click)="tomarCiencia(os)"
                  *ngIf="os.acao_necessaria === 'TOMAR_CIENCIA'"
                  title="Tomar ciÃªncia">
                  <i class="bi bi-check2-circle"></i>
                </button>

                <button
                  class="btn btn-outline-info"
                  (click)="iniciarTrabalho(os)"
                  *ngIf="os.acao_necessaria === 'INICIAR_TRABALHO'"
                  title="Iniciar trabalho">
                  <i class="bi bi-play-circle"></i>
                </button>

                <button
                  class="btn btn-outline-secondary"
                  (click)="baixarPdf(os)"
                  title="Baixar PDF">
                  <i class="bi bi-file-pdf"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODO CARDS -->
  <div class="row g-3" *ngIf="!loading && ordensServico.length > 0 && modoExibicao === 'cards'">
    <div class="col-md-6 col-lg-4" *ngFor="let os of ordensServico">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-{{ getStatusColor(os.status) }} text-white">
          <div class="d-flex justify-content-between align-items-center">
            <strong>{{ os.numero_os }}</strong>
            <span class="badge bg-light text-dark" *ngIf="os.numero_reiteracao > 0">
              {{ os.numero_reiteracao }}Âª ReiteraÃ§Ã£o
            </span>
          </div>
        </div>

        <div class="card-body">
          <p class="mb-2">
            <strong>OcorrÃªncia:</strong> {{ os.ocorrencia.numero_ocorrencia }}
          </p>

          <p class="mb-2" *ngIf="os.perito_destinatario">
            <strong>Perito:</strong> {{ os.perito_destinatario.nome_completo }}
          </p>

          <p class="mb-2">
            <strong>Status:</strong>
            <span class="badge bg-{{ getStatusColor(os.status) }} ms-2">
              {{ getStatusLabel(os.status) }}
            </span>
          </p>

          <p class="mb-2">
            <strong>UrgÃªncia:</strong>
            <span
              class="badge bg-{{ getUrgenciaInfo(os.urgencia).cor }} ms-2"
              *ngIf="os.urgencia">
              {{ getUrgenciaInfo(os.urgencia).icone }} {{ getUrgenciaInfo(os.urgencia).label }}
            </span>
            <span class="badge bg-secondary ms-2" *ngIf="!os.urgencia">
              ğŸ”’ Sem CiÃªncia
            </span>
          </p>

          <p class="mb-2">
            <strong>Prazo:</strong> {{ os.prazo_dias }} dia(s)
          </p>

          <p class="mb-0">
            <strong>Restante:</strong>
            <span
              [class.text-danger]="os.dias_restantes !== null && os.dias_restantes < 0"
              [class.text-warning]="os.dias_restantes !== null && os.dias_restantes >= 0 && os.dias_restantes <= 2"
              [class.fw-bold]="os.dias_restantes !== null && os.dias_restantes <= 2">
              {{ getDiasRestantesTexto(os) }}
            </span>
          </p>

          <!-- Barra de progresso -->
          <div class="progress mt-3" style="height: 8px;" *ngIf="os.percentual_prazo_consumido > 0">
            <div
              class="progress-bar"
              [class.bg-success]="os.percentual_prazo_consumido <= 50"
              [class.bg-warning]="os.percentual_prazo_consumido > 50 && os.percentual_prazo_consumido <= 80"
              [class.bg-danger]="os.percentual_prazo_consumido > 80"
              [style.width.%]="os.percentual_prazo_consumido">
            </div>
          </div>
        </div>

        <!-- AÃ§Ãµes -->
<td class="text-center">
  <div class="d-flex gap-1 justify-content-center">
    <!-- Ver Detalhes -->
    <button
      type="button"
      class="btn btn-sm btn-outline-primary"
      (click)="verDetalhes(os)"
      title="Ver detalhes">
      <i class="bi bi-eye"></i>
    </button>

    <!-- Tomar CiÃªncia -->
    <button
      type="button"
      class="btn btn-sm btn-success"
      (click)="tomarCiencia(os)"
      *ngIf="os.acao_necessaria === 'TOMAR_CIENCIA'"
      title="Tomar ciÃªncia">
      <i class="bi bi-check2-circle"></i>
    </button>

    <!-- Iniciar Trabalho -->
    <button
      type="button"
      class="btn btn-sm btn-info"
      (click)="iniciarTrabalho(os)"
      *ngIf="os.acao_necessaria === 'INICIAR_TRABALHO'"
      title="Iniciar trabalho">
      <i class="bi bi-play-circle"></i>
    </button>

    <!-- PDF -->
    <button
      type="button"
      class="btn btn-sm btn-outline-secondary"
      (click)="baixarPdf(os)"
      title="Baixar PDF">
      <i class="bi bi-file-pdf"></i>
    </button>
  </div>
</td>
  <!-- PAGINAÃ‡ÃƒO -->
  <nav aria-label="PaginaÃ§Ã£o" *ngIf="!loading && ordensServico.length > 0 && totalPaginas > 1" class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="paginaAtual === 1">
        <a class="page-link" (click)="irParaPagina(paginaAtual - 1)">
          Anterior
        </a>
      </li>

      <li
        class="page-item"
        *ngFor="let pagina of getPaginas()"
        [class.active]="pagina === paginaAtual">
        <a class="page-link" (click)="irParaPagina(pagina)">
          {{ pagina }}
        </a>
      </li>

      <li class="page-item" [class.disabled]="paginaAtual === totalPaginas">
        <a class="page-link" (click)="irParaPagina(paginaAtual + 1)">
          PrÃ³ximo
        </a>
      </li>
    </ul>
  </nav>
</div>
