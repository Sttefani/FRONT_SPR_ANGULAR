<div class="container">
  <div class="header-actions">
    <button class="btn-back" (click)="cancelar()">
      <i class="bi bi-arrow-left"></i> Voltar
    </button>
    <h1>{{ isEditMode ? 'Editar Procedimento Cadastrado' : 'Novo Procedimento Cadastrado' }}</h1>
  </div>

  @if (isLoading || isLoadingTipos) {
    <div class="loading">
      <i class="bi bi-hourglass-split"></i>
      <p>Carregando dados...</p>
    </div>
  }

  @if (message) {
    <div class="message" [ngClass]="{'success': messageType === 'success', 'error': messageType === 'error'}">
      {{ message }}
    </div>
  }

  @if (!isLoading && !isLoadingTipos) {
    <div class="form-container">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="tipo_procedimento_id">
            <i class="bi bi-file-earmark-text"></i>
            Tipo de Procedimento *
          </label>
          <select
            id="tipo_procedimento_id"
            formControlName="tipo_procedimento_id"
            class="form-control"
            [class.error]="tipo_procedimento_id?.invalid && tipo_procedimento_id?.touched"
          >
            <option value="">Selecione um tipo</option>
            @for (tipo of tiposProcedimento; track tipo.id) {
              <option [value]="tipo.id">{{ tipo.sigla }} - {{ tipo.nome }}</option>
            }
          </select>
          @if (tipo_procedimento_id?.invalid && tipo_procedimento_id?.touched) {
            <div class="error-message">
              <span>Selecione um tipo de procedimento.</span>
            </div>
          }
          <small class="hint">Ex: APF, IP, BO</small>
        </div>

        <div class="form-group">
          <label for="numero">
            <i class="bi bi-hash"></i>
            Número *
          </label>
          <input
            type="text"
            id="numero"
            formControlName="numero"
            class="form-control"
            placeholder="Ex: 123, 456-A, 789/2025"
            maxlength="50"
            [class.error]="numero?.invalid && numero?.touched"
          >
          @if (numero?.invalid && numero?.touched) {
            <div class="error-message">
              @if (numero?.errors?.['required']) {
                <span>O número é obrigatório.</span>
              }
              @if (numero?.errors?.['maxlength']) {
                <span>O número deve ter no máximo 50 caracteres.</span>
              }
            </div>
          }
          <small class="hint">Pode conter letras e caracteres especiais. Será convertido para maiúsculas.</small>
        </div>

        <div class="form-group">
          <label for="ano">
            <i class="bi bi-calendar"></i>
            Ano *
          </label>
          <input
            type="number"
            id="ano"
            formControlName="ano"
            class="form-control"
            placeholder="Ex: 2025"
            [min]="1900"
            [max]="anoAtual + 1"
            [class.error]="ano?.invalid && ano?.touched"
          >
          @if (ano?.invalid && ano?.touched) {
            <div class="error-message">
              @if (ano?.errors?.['required']) {
                <span>O ano é obrigatório.</span>
              }
              @if (ano?.errors?.['min']) {
                <span>O ano deve ser maior que 1900.</span>
              }
              @if (ano?.errors?.['max']) {
                <span>O ano não pode ser superior a {{ anoAtual + 1 }}.</span>
              }
            </div>
          }
          <small class="hint">Ano do procedimento</small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="isSaving">
            <i class="bi bi-x-circle"></i>
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="form.invalid || isSaving">
            <i class="bi bi-check-circle"></i>
            {{ isSaving ? 'Salvando...' : (isEditMode ? 'Atualizar' : 'Cadastrar') }}
          </button>
        </div>
      </form>
    </div>
  }
</div>
