<div class="container">
  <div class="page-header">
    <h1><i class="bi bi-bar-chart-line-fill"></i> Relatórios Gerenciais</h1>
    <p>Análise de dados e estatísticas agregadas sobre as ocorrências do sistema.</p>
  </div>

  <div class="filters-bar">
    <div class="filter-group">
      <label for="data_inicio">Data de Início</label>
      <input type="date" id="data_inicio" [(ngModel)]="filtros.data_inicio">
    </div>
    <div class="filter-group">
      <label for="data_fim">Data de Fim</label>
      <input type="date" id="data_fim" [(ngModel)]="filtros.data_fim">
    </div>
    <div class="filter-group">
      <label for="servicoFiltro">Serviço Pericial</label>
      <select id="servicoFiltro" [(ngModel)]="filtros.servico_id">
        <option [ngValue]="null">Todos</option>
        @for (servico of servicosDisponiveis; track servico.id) { <option [value]="servico.id">{{ servico.sigla }}</option> }
      </select>
    </div>

    <div class="filter-group">
      <label for="cidadeFiltro">Cidade</label>
      <select id="cidadeFiltro" [(ngModel)]="filtros.cidade_id">
        <option [ngValue]="null">Todas</option>
        @for (cidade of cidadesDisponiveis; track cidade.id) {
          <option [value]="cidade.id">{{ cidade.nome }}</option>
        }
      </select>
    </div>

    <div class="filter-group">
      <label for="peritoFiltro">Perito</label>
      <select id="peritoFiltro" [(ngModel)]="filtros.perito_id">
        <option [ngValue]="null">Todos</option>
        @for (perito of peritosDisponiveis; track perito.id) { <option [value]="perito.id">{{ perito.nome_completo }}</option> }
      </select>
    </div>
    <div class="filter-group">
      <label for="classificacaoFiltro">Classificação (Grupo ou Subgrupo)</label>
      <select id="classificacaoFiltro" [(ngModel)]="filtros.classificacao_id">
        <option [ngValue]="null">Todas</option>
        @for (c of classificacoesDisponiveis; track c.id) { <option [value]="c.id">{{ c.codigo }} - {{ c.nome }}</option> }
      </select>
    </div>
    <div class="filter-actions">
      <button class="btn-primary" (click)="aplicarFiltros()">Aplicar Filtros</button>
      <button class="btn-secondary" (click)="limparFiltros()">Limpar</button>
      <div class="pdf-actions">
      <button
        class="btn-pdf"
        (click)="gerarPDF()"
        [disabled]="isGerandoPDF || isLoading"
        title="Gerar PDF dos relatórios filtrados">
        @if (isGerandoPDF) {
          <i class="bi bi-hourglass-split"></i>
          <span>Gerando PDF...</span>
        } @else {
          <i class="bi bi-file-earmark-pdf-fill"></i>
          <span>Gerar PDF</span>
        }
      </button>
    </div>
    </div>
  </div>

  @if (isLoading) {
    <div class="loading-state"><i class="bi bi-hourglass-split"></i><p>Gerando relatórios...</p></div>
  }

  @if (!isLoading && relatorios) {
    <!-- Tabela: Ocorrências por Grupo Principal -->
    @if (relatorios.por_grupo_principal && relatorios.por_grupo_principal.length > 0) {
      <div class="data-section">
        <h2>Ocorrências por Grupo Principal</h2>
        <table class="data-table">
          <thead><tr><th>Código</th><th>Grupo</th><th class="text-right">Total</th></tr></thead>
          <tbody>
            @for (item of relatorios.por_grupo_principal; track $index) {
              <tr><td>{{ item.grupo_codigo }}</td><td>{{ item.grupo_nome }}</td><td class="text-right">{{ item.total | number }}</td></tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Tabela: Ocorrências por Classificação Específica -->
    @if (relatorios.por_classificacao_especifica && relatorios.por_classificacao_especifica.length > 0) {
      <div class="data-section">
        <h2>Ocorrências por Classificação Específica (Subgrupos)</h2>
        <table class="data-table">
          <thead><tr><th>Código</th><th>Nome</th><th class="text-right">Total</th></tr></thead>
          <tbody>
            @for (item of relatorios.por_classificacao_especifica; track $index) {
              <tr><td>{{ item.classificacao__codigo }}</td><td>{{ item.classificacao__nome }}</td><td class="text-right">{{ item.total | number }}</td></tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Tabela: Produção por Perito -->
    @if (relatorios.producao_por_perito && relatorios.producao_por_perito.length > 0) {
      <div class="data-section">
        <h2>Produção por Perito</h2>
        <table class="data-table">
          <thead><tr><th>Perito</th><th class="text-right">Total Atribuído</th><th class="text-right">Finalizadas</th><th class="text-right">Em Análise</th></tr></thead>
          <tbody>
            @for (item of relatorios.producao_por_perito; track $index) {
              <tr><td>{{ item.nome_completo }}</td><td class="text-right">{{ item.total_ocorrencias | number }}</td><td class="text-right">{{ item.finalizadas | number }}</td><td class="text-right">{{ item.em_analise | number }}</td></tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Tabela: Produção por Serviço Pericial (COM COLUNA TOTAL EXAMES) -->
    @if (relatorios.por_servico && relatorios.por_servico.length > 0) {
      <div class="data-section">
        <h2>Produção por Serviço Pericial</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>Serviço</th>
              <th class="text-right">Total OCs</th>
              <th class="text-right">Total Exames</th>
              <th class="text-right">Finalizadas</th>
              <th class="text-right">Em Análise</th>
            </tr>
          </thead>
          <tbody>
            @for (item of relatorios.por_servico; track $index) {
              <tr>
                <td>{{ item.servico_pericial__sigla }} - {{ item.servico_pericial__nome }}</td>
                <td class="text-right">{{ item.total | number }}</td>
                <td class="text-right">{{ item.total_exames | number }}</td>
                <td class="text-right">{{ item.finalizadas | number }}</td>
                <td class="text-right">{{ item.em_analise | number }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Tabela: Exames Solicitados -->
    <div class="data-section">
      <h2>Exames Solicitados</h2>
      @if (relatorios.por_exame && relatorios.por_exame.length > 0) {
        <table class="data-table">
          <thead>
            <tr>
              <th>Código</th>
              <th>Exame</th>
              <th>Serviço</th>
              <th class="text-right">Quantidade</th>
            </tr>
          </thead>
          <tbody>
            @for (item of relatorios.por_exame; track $index) {
              <tr>
                <td>{{ item.codigo }}</td>
                <td>{{ item.nome }}</td>
                <td>{{ item.servico_sigla }}</td>
                <td class="text-right">{{ item.quantidade | number }}</td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <div class="empty-state-inline">
          <p>Nenhum exame foi solicitado no período filtrado.</p>
        </div>
      }
    </div>

  } @else if (!isLoading) {
    <div class="empty-state">
      <i class="bi bi-info-circle"></i>
      <p>Nenhum dado encontrado para os filtros selecionados.</p>
    </div>
  }
</div>
